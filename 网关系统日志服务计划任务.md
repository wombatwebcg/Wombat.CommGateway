# 上下文
文件名：网关系统日志服务计划任务.md
创建于：2024-12-19
创建者：用户/AI
关联协议：RIPER-5 + Multidimensional + Agent Protocol 

# 任务描述
为网关系统在 `Wombat.CommGateway.Application` 层添加完整的日志服务和计划任务系统。需要实现：
1. **系统日志服务**：统一管理各类日志（操作日志、错误日志、性能日志、通信日志）
2. **日志计划任务**：定期清理过期日志、生成日志报告、日志统计分析
3. **日志存储和查询**：支持数据库存储、文件存储、结构化查询
4. **日志可视化**：通过 SignalR 实现实时日志推送到前端
5. **日志配置管理**：动态配置日志级别、保留策略、存储策略

# 项目概述
这是一个基于 .NET 8.0 的工业通信网关系统，采用 Clean Architecture 架构：
- **Api层**：已配置 Serilog + RequestLogMiddleware
- **Application层**：业务逻辑层，包含多个服务和后台任务
- **Infrastructure层**：基础设施层，包含数据访问和外部服务
- **Domain层**：领域层，包含实体和仓储接口

现有技术栈：
- Serilog（已配置）
- FreeSql ORM（SQLite数据库）
- AutoInject 依赖注入
- SignalR 实时通信
- 现有后台服务：DataCollectionService

---
*以下部分由 AI 在协议执行过程中维护*
---

# 分析 (由 RESEARCH 模式填充)
## 现有日志架构分析
- **Serilog配置**：通过 `SerilogHelper.Build()` 初始化，但具体配置未明确
- **HTTP请求日志**：`RequestLogMiddleware` 记录所有HTTP请求详细信息
- **异常日志**：`GlobalExceptionFilter` 处理全局异常记录
- **现有后台服务**：`DataCollectionService` 已作为 `BackgroundService` 运行

## 项目结构特点
- **依赖注入**：使用 `AutoInject` 特性自动注册服务
- **服务生命周期**：支持 Singleton、Scoped、Transient
- **数据访问**：FreeSql + Repository 模式
- **实时通信**：SignalR Hub 已配置用于数据推送
- **配置管理**：appsettings.json 配置各类服务参数

## 关键文件和约束
- `Program.cs`：服务注册入口
- `appsettings.json`：配置文件
- `AutoInjectExtension`：自动依赖注入扩展
- 数据库：SQLite (gateway.db3)
- 现有服务接口模式：I{ServiceName}Service

## 技术依赖
- Serilog.Extensions.Hosting：8.0.0
- FreeSql.Provider.Sqlite：3.5.205
- Microsoft.Extensions.Hosting：后台服务支持
- SignalR：实时通信

# 提议的解决方案 (由 INNOVATE 模式填充)

## 解决方案选择：统一日志服务架构

### 方案对比分析

#### 方案1：扩展现有Serilog架构
- **优点**：最小化系统变更，快速实现
- **缺点**：功能扩展受限，复杂查询困难
- **适用场景**：简单日志需求

#### 方案2：混合架构模式  
- **优点**：兼顾稳定性和功能性
- **缺点**：维护两套日志系统，配置复杂
- **适用场景**：渐进式升级

#### 方案3：统一日志服务架构 ⭐ **推荐**
- **优点**：最大灵活性，完整功能，架构一致
- **缺点**：实现复杂度高，开发周期长
- **适用场景**：工业级应用，长期维护

### 推荐方案详细设计

#### 核心架构设计
```
┌─────────────────────────────────────────────────────────────┐
│                    日志服务统一架构                          │
├─────────────────────────────────────────────────────────────┤
│ 应用层 │ Controllers/Hubs → LogService → LoggingHub        │
├─────────────────────────────────────────────────────────────┤
│ 服务层 │ ILogService → LogService → LogEventBus           │
├─────────────────────────────────────────────────────────────┤
│ 存储层 │ ILogRepository → LogRepository → Database/File   │
├─────────────────────────────────────────────────────────────┤
│ 任务层 │ LogScheduledTaskService → Timer/Cron Jobs       │
└─────────────────────────────────────────────────────────────┘
```

#### 关键组件设计

**1. 日志服务核心**
- `ILogService`: 统一日志服务接口
- `LogService`: 核心日志服务实现
- `LogEventBus`: 日志事件发布订阅总线

**2. 日志存储系统**
- `ILogRepository`: 日志仓储接口
- `LogRepository`: 数据库存储实现
- `FileLogRepository`: 文件存储实现

**3. 实时推送系统**
- `LoggingHub`: SignalR Hub 实现
- `ILogPushService`: 日志推送服务接口
- `LogPushService`: 实时推送服务实现

**4. 计划任务系统**
- `LogScheduledTaskService`: 日志计划任务服务
- `LogCleanupTask`: 日志清理任务
- `LogReportTask`: 日志报告生成任务

#### 技术创新点

**1. 发布-订阅模式**
- 复用现有 `IDataPushBus` 架构
- 支持多种输出目标（数据库、文件、SignalR）
- 异步处理，不阻塞主业务流程

**2. 分层日志管理**
- 系统级：框架日志、性能监控
- 业务级：操作日志、审计日志
- 通信级：设备通信、数据采集日志

**3. 动态配置管理**
- 运行时调整日志级别
- 动态存储策略配置
- 实时保留策略调整

**4. 高性能设计**
- 异步日志写入
- 批量处理机制
- 内存缓冲优化

#### 与现有架构的集成优势

**1. 完全兼容现有模式**
- 使用 `AutoInject` 特性自动注册
- 遵循 Repository 模式
- 集成现有 SignalR 基础设施

**2. 复用现有组件**
- 利用 `IDataPushBus` 进行事件分发
- 共享 `FreeSql` 数据访问层
- 集成现有配置管理系统

**3. 扩展现有功能**
- 增强 `RequestLogMiddleware` 功能
- 扩展 `GlobalExceptionFilter` 日志记录
- 与 `DataCollectionService` 协同工作

# 实施计划 (由 PLAN 模式生成)

## 技术架构规划

### 文件结构设计
```
Wombat.CommGateway.Application/
├── Services/
│   ├── Logging/
│   │   ├── LogService.cs                    # 核心日志服务
│   │   ├── LogPushService.cs                # 实时推送服务
│   │   └── LogScheduledTaskService.cs       # 计划任务服务
├── Interfaces/
│   ├── ILogService.cs                       # 日志服务接口
│   ├── ILogPushService.cs                   # 推送服务接口
│   └── ILogRepository.cs                    # 日志仓储接口
├── Hubs/
│   └── LoggingHub.cs                        # SignalR Hub
├── DTOs/
│   └── Logging/
│       ├── LogEntryDto.cs                   # 日志条目DTO
│       ├── LogQueryDto.cs                   # 日志查询DTO
│       └── LogConfigDto.cs                  # 日志配置DTO
└── Common/
    └── Logging/
        ├── LogEventBus.cs                   # 日志事件总线
        ├── LogLevel.cs                      # 日志级别枚举
        └── LogCategory.cs                   # 日志分类枚举

Wombat.CommGateway.Domain/
├── Entities/
│   ├── SystemLog.cs                         # 系统日志实体
│   ├── OperationLog.cs                      # 操作日志实体
│   └── CommunicationLog.cs                  # 通信日志实体
└── Repositories/
    └── ILogRepository.cs                    # 日志仓储接口

Wombat.CommGateway.Infrastructure/
├── Repositories/
│   └── LogRepository.cs                     # 日志仓储实现
└── Extentions/
    └── LoggingExtensions.cs                 # 日志扩展方法
```

### 数据库设计
```sql
-- 系统日志表
CREATE TABLE SystemLogs (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    Level TEXT NOT NULL,
    Message TEXT NOT NULL,
    Template TEXT,
    Timestamp DATETIME NOT NULL,
    Exception TEXT,
    Properties TEXT,
    UserId INTEGER,
    SessionId TEXT,
    RequestId TEXT,
    Source TEXT,
    Category TEXT,
    CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 操作日志表  
CREATE TABLE OperationLogs (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    UserId INTEGER,
    Action TEXT NOT NULL,
    Resource TEXT,
    ResourceId INTEGER,
    Description TEXT,
    IpAddress TEXT,
    UserAgent TEXT,
    Timestamp DATETIME NOT NULL,
    Result TEXT,
    CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 通信日志表
CREATE TABLE CommunicationLogs (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    ChannelId INTEGER,
    DeviceId INTEGER,
    Direction TEXT NOT NULL, -- 'Send' or 'Receive'
    Protocol TEXT,
    Data TEXT,
    Status TEXT,
    ErrorMessage TEXT,
    ResponseTime INTEGER,
    Timestamp DATETIME NOT NULL,
    CreatedAt DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 配置文件扩展
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    },
    "GatewayLogging": {
      "DatabaseLogging": {
        "Enabled": true,
        "MinimumLevel": "Information",
        "MaxRetentionDays": 90
      },
      "FileLogging": {
        "Enabled": true,
        "Path": "logs/gateway.log",
        "RollingInterval": "Day",
        "MaxRetentionDays": 30
      },
      "RealTimePush": {
        "Enabled": true,
        "MaxConcurrentConnections": 100,
        "BufferSize": 1000
      },
      "ScheduledTasks": {
        "LogCleanup": {
          "Enabled": true,
          "Schedule": "0 2 * * *",  // 每天凌晨2点
          "MaxRetentionDays": 90
        },
        "LogReport": {
          "Enabled": true,
          "Schedule": "0 8 * * 1",  // 每周一上午8点
          "EmailRecipients": []
        }
      }
    }
  }
}
```

## 详细实施步骤

### 步骤1：领域层基础设施
**目标**：建立日志相关的领域模型和接口
- 创建日志实体类（SystemLog, OperationLog, CommunicationLog）
- 定义日志枚举（LogLevel, LogCategory）
- 创建日志仓储接口（ILogRepository）

### 步骤2：基础设施层实现
**目标**：实现数据访问和基础服务
- 实现LogRepository（基于FreeSql）
- 创建数据库表结构
- 实现基础CRUD操作

### 步骤3：应用层核心服务
**目标**：实现核心日志服务功能
- 创建ILogService接口
- 实现LogService核心服务
- 实现LogEventBus事件总线

### 步骤4：实时推送功能
**目标**：实现日志的实时推送
- 创建LoggingHub（SignalR）
- 实现ILogPushService接口
- 实现LogPushService服务

### 步骤5：计划任务服务
**目标**：实现日志管理的后台任务
- 创建LogScheduledTaskService
- 实现日志清理功能
- 实现日志报告生成

### 步骤6：系统集成配置
**目标**：完成服务注册和系统集成
- 更新appsettings.json配置
- 在Program.cs中注册服务
- 配置AutoInject注册

实施检查清单：
1. 创建领域层日志实体类和枚举
2. 实现基础设施层日志仓储
3. 创建应用层日志服务接口
4. 实现核心LogService服务
5. 创建日志事件总线LogEventBus
6. 实现LoggingHub SignalR Hub
7. 创建日志推送服务
8. 实现计划任务服务
9. 创建日志DTO类
10. 更新配置文件
11. 注册所有服务到DI容器
12. 创建数据库表结构
13. 集成现有中间件和过滤器
14. 实现日志查询API
15. 添加日志管理Controller

# 当前执行步骤 (由 EXECUTE 模式在开始执行某步骤时更新)
> 正在执行: "步骤1 - 创建领域层日志实体类和枚举"

# 任务进度 (由 EXECUTE 模式在每步完成后追加)
*   [2024-12-19 09:30:00]
    *   步骤：步骤1 - 领域层基础设施
    *   修改：创建 LogLevel、LogCategory 枚举和 SystemLog、OperationLog、CommunicationLog 实体类
    *   更改摘要：建立领域层日志相关实体和枚举，定义完整的字段结构和业务方法
    *   原因：执行计划步骤 1
    *   阻碍：无
    *   用户确认状态：成功
*   [2024-12-19 09:45:00]
    *   步骤：步骤2 - 基础设施层仓储
    *   修改：创建三个仓储接口和实现类 (SystemLogRepository、OperationLogRepository、CommunicationLogRepository)
    *   更改摘要：实现完整的数据访问层，支持分页查询、条件过滤、统计分析和批量删除
    *   原因：执行计划步骤 2
    *   阻碍：无
    *   用户确认状态：成功
*   [2024-12-19 10:00:00]
    *   步骤：步骤3 - 应用层服务接口
    *   修改：创建 ILogService、ILogPushService 接口和 LogEventBus 事件总线
    *   更改摘要：定义完整的日志服务接口，实现发布订阅模式和事件总线架构
    *   原因：执行计划步骤 3
    *   阻碍：无
    *   用户确认状态：成功
*   [2024-12-19 10:15:00]
    *   步骤：步骤4 - 实现核心LogService服务
    *   修改：创建 LogService 类文件 (452行代码)
    *   更改摘要：实现完整的日志服务，包含系统日志、操作日志、通信日志的记录/查询/统计/清理功能，集成事件总线和异常处理
    *   原因：执行计划步骤 4
    *   阻碍：无
    *   用户确认状态：待确认

# 当前执行步骤 (由 EXECUTE 模式在开始执行某步骤时更新)
> 正在执行: "步骤4 - 实现核心LogService服务" 