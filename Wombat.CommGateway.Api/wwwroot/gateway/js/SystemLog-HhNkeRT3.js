import{d as e,r as a,v as l,o as t,a4 as s,c as o,b as u,e as n,n as i,w as r,g as d,k as c,a5 as v,E as m,U as f,a6 as _,t as p,a2 as g,a7 as y,a8 as b,q as h,I as S,h as w,j as C}from"./index-Bo2QAGFo.js";import{L as D,a as x,s as I}from"./LogTable-uQzsPwIb.js";import{a as k,b as V,L,c as E,d as U,e as j}from"./log-B_3kzNYK.js";import{_ as O}from"./_plugin-vue_export-helper-BCo6x5W8.js";const T={class:"system-log-container"},z={class:"page-header"},R={class:"header-left"},P={class:"page-title"},q={class:"header-right"},J={class:"stat-content"},N={class:"stat-icon"},F={class:"stat-info"},W={class:"stat-value"},$={class:"stat-content"},A={class:"stat-icon error"},B={class:"stat-info"},G={class:"stat-value"},H={class:"stat-content"},K={class:"stat-icon warning"},M={class:"stat-info"},Q={class:"stat-value"},X={class:"stat-content"},Y={class:"stat-icon success"},Z={class:"stat-info"},ee={class:"stat-value"},ae=O(e({__name:"SystemLog",setup(e){const O=w(),ae=a(!1),le=a([]),te=a(0),se=a({totalCount:0,levelDistribution:{},categoryDistribution:{},recentCount:0}),oe=a({page:1,pageSize:20,category:k.System}),ue=a([]),ne=a(),ie=a(!1),re=a(!1),de=a(!1),ce=a(!1),ve=a({format:"xlsx",fields:["timestamp","level","message","source","environment"]}),me=l((()=>(se.value.levelDistribution[V.Error]||0)+(se.value.levelDistribution[V.Critical]||0)+(se.value.levelDistribution[V.Fatal]||0))),fe=l((()=>se.value.levelDistribution[V.Warning]||0)),_e=[{key:"source",label:"日志来源",type:"input"},{key:"environment",label:"运行环境",type:"select",options:[{label:"开发环境",value:"Development"},{label:"测试环境",value:"Testing"},{label:"生产环境",value:"Production"}]}],pe=[{prop:"source",label:"来源",width:120,sortable:!0,formatter:e=>e||"未知"},{prop:"environment",label:"环境",width:100,sortable:!0,formatter:e=>e||"未知"},{prop:"threadId",label:"线程ID",width:100,formatter:e=>e||"-"}];let ge=null,ye=null,be=null;const he=e=>{const a={...oe.value,...e,page:1};JSON.stringify(a)!==JSON.stringify(oe.value)&&(oe.value=a,Ve())},Se=(e,a)=>{oe.value.page=e,oe.value.pageSize=a,Ve()},we=(e,a)=>{},Ce=e=>{ue.value=e},De=e=>{ne.value=e,ie.value=!0},xe=e=>{re.value=!0,oe.value={...oe.value,...e}},Ie=e=>{ce.value=e,e?Ue():je()},ke=()=>{O.push("/log")},Ve=async()=>{ae.value=!0;try{const e=await E(oe.value);le.value=e.items,te.value=e.total}catch(e){m.error("加载数据失败"),le.value=[{id:"1",timestamp:(new Date).toISOString(),level:V.Information,category:k.System,message:"系统启动完成",source:"SystemService",environment:"Production",threadId:"1"},{id:"2",timestamp:new Date(Date.now()-6e4).toISOString(),level:V.Error,category:k.System,message:"数据库连接失败",source:"DatabaseService",environment:"Production",threadId:"2",exception:"System.Data.SqlClient.SqlException: 连接超时"}],te.value=2}finally{ae.value=!1}},Le=async()=>{try{const e=await U();se.value=e}catch(e){se.value={totalCount:1250,levelDistribution:{[V.Debug]:100,[V.Information]:800,[V.Warning]:300,[V.Error]:45,[V.Critical]:5,[V.Fatal]:0},categoryDistribution:{[k.System]:1250},recentCount:45}}},Ee=async()=>{de.value=!0;try{const e={...oe.value,format:ve.value.format,fields:ve.value.fields},a=await j(e),l=URL.createObjectURL(a),t=document.createElement("a");t.href=l,t.download=`system_logs_${(new Date).toISOString().split("T")[0]}.${ve.value.format}`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(l),m.success("导出成功"),re.value=!1}catch(e){m.error("导出失败，请稍后重试")}finally{de.value=!1}},Ue=async()=>{try{ye=e=>{le.value.unshift(e),le.value.length>1e3&&(le.value=le.value.slice(0,1e3)),be&&clearTimeout(be),be=setTimeout((()=>{Le()}),2e3)},await I.subscribeSystemLogs(ye),m.success("已启用实时日志推送")}catch(e){m.error("启用实时推送失败"),ye=null,ge=setInterval((()=>{Ve()}),5e3)}},je=async()=>{try{ye&&(await I.unsubscribeSystemLogs(ye),ye=null,m.info("已停用实时日志推送"))}catch(e){}ge&&(clearInterval(ge),ge=null)};return t((()=>{Ve(),Le()})),s((()=>{je(),be&&(clearTimeout(be),be=null)})),(e,a)=>{const l=d("el-icon"),t=d("el-button"),s=d("el-card"),w=d("el-col"),I=d("el-row"),E=d("el-radio"),U=d("el-radio-group"),j=d("el-form-item"),O=d("el-checkbox"),ue=d("el-checkbox-group"),ce=d("el-form"),ge=d("el-dialog");return C(),o("div",T,[u("div",z,[u("div",R,[u("h1",P,[n(l,{class:"title-icon"},{default:r((()=>[n(c(f))])),_:1}),a[5]||(a[5]=i(" 系统日志 "))]),a[6]||(a[6]=u("p",{class:"page-subtitle"},"系统运行状态、错误信息、性能监控等日志记录",-1))]),u("div",q,[n(t,{type:"primary",icon:c(v),onClick:ke},{default:r((()=>a[7]||(a[7]=[i(" 返回日志管理 ")]))),_:1,__:[7]},8,["icon"])])]),n(I,{gutter:16,class:"stats-row"},{default:r((()=>[n(w,{span:6},{default:r((()=>[n(s,{shadow:"never",class:"stat-card"},{default:r((()=>[u("div",J,[u("div",N,[n(l,null,{default:r((()=>[n(c(_))])),_:1})]),u("div",F,[u("div",W,p(se.value.totalCount||0),1),a[8]||(a[8]=u("div",{class:"stat-label"},"总日志数",-1))])])])),_:1})])),_:1}),n(w,{span:6},{default:r((()=>[n(s,{shadow:"never",class:"stat-card"},{default:r((()=>[u("div",$,[u("div",A,[n(l,null,{default:r((()=>[n(c(g))])),_:1})]),u("div",B,[u("div",G,p(me.value),1),a[9]||(a[9]=u("div",{class:"stat-label"},"错误日志",-1))])])])),_:1})])),_:1}),n(w,{span:6},{default:r((()=>[n(s,{shadow:"never",class:"stat-card"},{default:r((()=>[u("div",H,[u("div",K,[n(l,null,{default:r((()=>[n(c(y))])),_:1})]),u("div",M,[u("div",Q,p(fe.value),1),a[10]||(a[10]=u("div",{class:"stat-label"},"警告日志",-1))])])])),_:1})])),_:1}),n(w,{span:6},{default:r((()=>[n(s,{shadow:"never",class:"stat-card"},{default:r((()=>[u("div",X,[u("div",Y,[n(l,null,{default:r((()=>[n(c(b))])),_:1})]),u("div",Z,[u("div",ee,p(se.value.recentCount||0),1),a[11]||(a[11]=u("div",{class:"stat-label"},"今日新增",-1))])])])),_:1})])),_:1})])),_:1}),n(D,{"extended-filters":_e,"default-params":{category:c(k).System},onSearch:he,onExport:xe,onRealTimeToggle:Ie},null,8,["default-params"]),n(x,{data:le.value,total:te.value,loading:ae.value,"current-page":oe.value.page,"page-size":oe.value.pageSize,"dynamic-columns":pe,selectable:!0,onPageChange:Se,onSortChange:we,onSelectionChange:Ce,onViewDetail:De},{actions:r((({row:e})=>[e.level>=c(V).Error?(C(),h(t,{key:0,type:"danger",link:"",size:"small",onClick:e=>{m.success("已标记为已读")}},{default:r((()=>a[12]||(a[12]=[i(" 标记已读 ")]))),_:2,__:[12]},1032,["onClick"])):S("",!0)])),_:1},8,["data","total","loading","current-page","page-size"]),n(L,{modelValue:ie.value,"onUpdate:modelValue":a[0]||(a[0]=e=>ie.value=e),"log-data":ne.value},null,8,["modelValue","log-data"]),n(ge,{modelValue:re.value,"onUpdate:modelValue":a[4]||(a[4]=e=>re.value=e),title:"导出系统日志",width:"500px","destroy-on-close":""},{footer:r((()=>[n(t,{onClick:a[3]||(a[3]=e=>re.value=!1)},{default:r((()=>a[23]||(a[23]=[i("取消")]))),_:1,__:[23]}),n(t,{type:"primary",onClick:Ee,loading:de.value},{default:r((()=>a[24]||(a[24]=[i(" 导出 ")]))),_:1,__:[24]},8,["loading"])])),default:r((()=>[n(ce,{model:ve.value,"label-width":"100px"},{default:r((()=>[n(j,{label:"导出格式"},{default:r((()=>[n(U,{modelValue:ve.value.format,"onUpdate:modelValue":a[1]||(a[1]=e=>ve.value.format=e)},{default:r((()=>[n(E,{value:"xlsx"},{default:r((()=>a[13]||(a[13]=[i("Excel文件")]))),_:1,__:[13]}),n(E,{value:"csv"},{default:r((()=>a[14]||(a[14]=[i("CSV文件")]))),_:1,__:[14]}),n(E,{value:"json"},{default:r((()=>a[15]||(a[15]=[i("JSON文件")]))),_:1,__:[15]})])),_:1},8,["modelValue"])])),_:1}),n(j,{label:"包含字段"},{default:r((()=>[n(ue,{modelValue:ve.value.fields,"onUpdate:modelValue":a[2]||(a[2]=e=>ve.value.fields=e)},{default:r((()=>[n(O,{value:"timestamp"},{default:r((()=>a[16]||(a[16]=[i("时间戳")]))),_:1,__:[16]}),n(O,{value:"level"},{default:r((()=>a[17]||(a[17]=[i("日志级别")]))),_:1,__:[17]}),n(O,{value:"message"},{default:r((()=>a[18]||(a[18]=[i("消息内容")]))),_:1,__:[18]}),n(O,{value:"source"},{default:r((()=>a[19]||(a[19]=[i("日志来源")]))),_:1,__:[19]}),n(O,{value:"environment"},{default:r((()=>a[20]||(a[20]=[i("运行环境")]))),_:1,__:[20]}),n(O,{value:"threadId"},{default:r((()=>a[21]||(a[21]=[i("线程ID")]))),_:1,__:[21]}),n(O,{value:"exception"},{default:r((()=>a[22]||(a[22]=[i("异常信息")]))),_:1,__:[22]})])),_:1},8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-991dd8e6"]]);export{ae as default};
