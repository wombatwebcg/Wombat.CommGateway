import{s as e,d as l,r as a,a as t,v as o,o as u,c as i,b as n,e as d,w as r,g as p,E as s,n as c,k as m,G as f,x as v,H as y,q as g,t as h,I as b,F as _,z as V,Z as T,D as w,j as U,P as k}from"./index-CNx6aW7Y.js";import{g as I}from"./device-C7WykcV5.js";import{_ as C}from"./_plugin-vue_export-helper-BCo6x5W8.js";const D={class:"rules-container"},S={class:"page-header"},$={key:0},x={key:1},O={key:2},M={class:"pagination"},H={class:"condition-header"},N={class:"action-header"},E={key:0,class:"test-result-data"},P={class:"result-actions"},q=C(l({__name:"index",setup(l){const C=a(!1),q=a([]),j=a(0),B=a(!1),Q=a("add"),R=a(),z=a(!1),G=a(),J=a(null),L=a(null),A=a([]),Y=a([]),F=a([]),Z=a(0),K=a(">"),W=a(null),X=a(null),ee=a([]),le=t({page:1,pageSize:10,name:"",status:"1",triggerType:"TimeBased",actionType:"MQTT"}),ae=t({triggerValue:"",pointId:0,deviceId:0,timestamp:(new Date).toISOString(),quality:"GOOD",dataType:"",additionalData:{}}),te=t({id:0,name:"",description:"",condition:"",action:"",priority:1,enable:!0,type:"Threshold",deviceId:void 0,pointId:void 0}),oe={name:[{required:!0,message:"请输入规则名称",trigger:"blur"}],type:[{required:!0,message:"请选择规则类型",trigger:"change"}],deviceId:[{required:!0,message:"请选择设备",trigger:"change"}],pointId:[{required:!1,message:"请选择数据点",trigger:"change"}],priority:[{required:!0,message:"请输入优先级",trigger:"blur"}]},ue=o((()=>F.value.map((e=>{const l=JSON.stringify(e.config);return`${e.type}(${l})`})).join("\n"))),ie=async()=>{C.value=!0;try{const a=await(l=le,e({url:"/api/Rule",method:"get",params:l}));q.value=a.items,j.value=a.total}catch(a){s.error("获取规则列表失败")}finally{C.value=!1}var l},ne=async l=>{if(l)try{const a=await function(l){return e({url:`/api/DevicePoint/${l}`,method:"get"})}(l);Y.value=a}catch(a){s.error("获取点位列表失败")}else Y.value=[]},de=()=>{Object.assign(le,{page:1,pageSize:10,name:"",status:"1",triggerType:"TimeBased",actionType:"MQTT"}),ie()},re=e=>{le.pageSize=e,ie()},pe=e=>{le.page=e,ie()},se=()=>{Q.value="add",ce(),B.value=!0},ce=()=>{Object.assign(te,{id:0,name:"",description:"",condition:"",action:"",priority:1,enable:!0,type:"Threshold",deviceId:void 0,pointId:void 0}),Z.value=0,K.value=">",W.value=null,X.value=null,F.value=[],ee.value=[],we()},me=()=>{if("TimeBased"===te.type&&(te.pointId=void 0),ee.value=[],"Threshold"===te.type)we();else if("TimeBased"===te.type){const e=new Date,l=new Date(e);l.setHours(0,0,0);const a=new Date(e);a.setHours(23,59,59),W.value=l,X.value=a,ee.value.push({operator:"time",value:"timespan"})}else"Conditional"===te.type&&ee.value.push({operator:"point.value > 0",value:""})},fe=e=>{te.pointId=void 0,ne(e)},ve=()=>{F.value.push({type:"MQTT",config:{topic:"",payload:""}})},ye=async l=>{Q.value="edit",ce();try{const o=await(a=l.id,e({url:`/api/Rule/${a}`,method:"get"}));if(Object.assign(te,{id:o.id,name:o.name,description:o.description,priority:o.priority,enable:o.enable,type:o.type||"Threshold",deviceId:o.deviceId,pointId:o.pointId}),o.deviceId&&await ne(o.deviceId),ee.value=[],o.conditions&&o.conditions.length>0)ee.value=o.conditions.map((e=>{if("Threshold"===te.type&&e.operator){const l=e.operator.match(/point\.value\s*([><=!]+)/);if(l)return{...e,operator:l[1]}}return e}));else if(o.condition)if("Threshold"===te.type){const e=o.condition.match(/point\.value\s*([><=!]+)\s*(\d+)/);e&&ee.value.push({operator:e[1],value:e[2]})}else if("TimeBased"===te.type){const e=o.condition.match(/time\s*>=\s*'([^']+)'\s*&&\s*time\s*<=\s*'([^']+)'/);if(e){const[l,a,t]=e,o=new Date,[u,i,n]=a.split(":").map(Number),[d,r,p]=t.split(":").map(Number),s=new Date(o);s.setHours(u,i,n);const c=new Date(o);c.setHours(d,r,p),W.value=s,X.value=c,ee.value.push({operator:"time",value:"timespan"})}}else ee.value.push({operator:o.condition,value:""});if(0===ee.value.length&&we(),o.action)try{const e=o.action.split("\n");F.value=e.map((e=>{const l=e.match(/(\w+)\((.+)\)/);if(l){const[e,t,o]=l;try{return{type:t,config:JSON.parse(o)}}catch(a){return{type:t,config:{}}}}return{type:"MQTT",config:{topic:"",payload:""}}}))}catch(t){F.value=[{type:"MQTT",config:{topic:"",payload:""}}]}else ve();B.value=!0}catch(o){s.error("获取规则详情失败")}var a},ge=async l=>{try{await(a=l.id,t=l.enable,e({url:`/api/Rule/${a}/status`,method:"put",data:{status:t?1:0}})),s.success("状态更新成功"),ie()}catch(o){s.error("更新状态失败")}var a,t},he=l=>{w.confirm("确定要删除该规则吗？","提示",{type:"warning"}).then((async()=>{try{await(a=l.id,e({url:`/api/Rule/${a}`,method:"delete"})),s.success("删除成功"),ie()}catch(t){s.error("删除失败")}var a}))},be=async()=>{R.value&&(()=>{if(0===F.value.length)return s.warning("请至少添加一个动作"),!1;for(let e=0;e<F.value.length;e++){const l=F.value[e];if("MQTT"===l.type){if(!l.config.topic)return s.warning(`动作${e+1}: MQTT主题不能为空`),!1;if(!l.config.payload)return s.warning(`动作${e+1}: MQTT消息内容不能为空`),!1}else if("HTTP"===l.type){if(!l.config.url)return s.warning(`动作${e+1}: HTTP URL不能为空`),!1;if(!l.config.method)return s.warning(`动作${e+1}: HTTP请求方法不能为空`),!1}else if("Database"===l.type){if(!l.config.table)return s.warning(`动作${e+1}: 数据库表名不能为空`),!1;if(!l.config.data)return s.warning(`动作${e+1}: 存储数据不能为空`),!1}else if("Email"===l.type){if(!l.config.to)return s.warning(`动作${e+1}: 收件人不能为空`),!1;if(!l.config.subject)return s.warning(`动作${e+1}: 邮件主题不能为空`),!1;if(!l.config.body)return s.warning(`动作${e+1}: 邮件内容不能为空`),!1;if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(l.config.to))return s.warning(`动作${e+1}: 收件人邮箱格式不正确`),!1}else if("SMS"===l.type){if(!l.config.phone)return s.warning(`动作${e+1}: 手机号不能为空`),!1;if(!l.config.content)return s.warning(`动作${e+1}: 短信内容不能为空`),!1;if(!/^1[3-9]\d{9}$/.test(l.config.phone))return s.warning(`动作${e+1}: 手机号格式不正确`),!1}}return!0})()&&(()=>{if(0===ee.value.length)return s.warning("请至少添加一个触发条件"),!1;for(let e=0;e<ee.value.length;e++){const l=ee.value[e];if("Threshold"===te.type){if(!l.operator)return s.warning(`条件${e+1}: 请选择比较操作符`),!1;if(void 0===l.value||""===l.value||isNaN(Number(l.value)))return s.warning(`条件${e+1}: 请输入有效的数值阈值`),!1}else if("Conditional"===te.type){if(!l.operator)return s.warning(`条件${e+1}: 条件表达式不能为空`),!1;if(!/[><=!]/.test(l.operator))return s.warning(`条件${e+1}: 条件表达式必须包含比较操作符(>, <, =, !=等)`),!1}else if("TimeBased"===te.type){if(!W.value||!X.value)return s.warning("请设置开始时间和结束时间"),!1;if(W.value>=X.value)return s.warning("开始时间必须早于结束时间"),!1}}return!0})()&&await R.value.validate((async l=>{if(l)try{const l=(()=>{const e=ue.value;let l=[...ee.value];"TimeBased"===te.type&&W.value&&X.value&&(l=[{operator:`time >= '${W.value.toTimeString().split(" ")[0]}' && time <= '${X.value.toTimeString().split(" ")[0]}'`,value:""}]);return"Threshold"===te.type&&(l=l.map((e=>e.operator&&e.operator.includes("point.value")?e:{...e,operator:`point.value ${e.operator}`}))),{id:te.id,name:te.name,description:te.description,condition:l.length>0?`${l[0].operator} ${l[0].value}`.trim():"",conditions:l,action:e,priority:te.priority,enable:te.enable,type:te.type,deviceId:te.deviceId,pointId:te.pointId,status:te.enable?"1":"0"}})();if("add"===Q.value){const{id:t,...o}=l;await(a=o,e({url:"/api/Rule",method:"post",data:a})),s.success("添加成功")}else await function(l){return e({url:`/api/Rule/${l.id}`,method:"put",data:l})}(l),s.success("更新成功");B.value=!1,ie()}catch(t){s.error("保存失败")}var a}))},_e=async()=>{if(L.value)try{let a={};if("string"==typeof ae.additionalData&&""!==ae.additionalData.trim())try{a=JSON.parse(ae.additionalData)}catch(l){return void s.error("附加数据格式不正确，请输入有效的JSON")}const t={triggerValue:ae.triggerValue,pointId:ae.pointId,deviceId:ae.deviceId,timestamp:"object"==typeof ae.timestamp?ae.timestamp.toISOString():String(ae.timestamp),quality:ae.quality,...a},o=await function(l,a){return e({url:`/api/Rule/${l}/test`,method:"post",data:{...a,timestamp:a.timestamp||(new Date).toISOString()}})}(L.value.id,t);J.value=o}catch(a){s.error("测试失败")}},Ve=e=>{if(!e)return"";return new Date(e).toLocaleString()},Te=()=>{if(!J.value)return;const e=JSON.stringify(J.value,null,2);navigator.clipboard.writeText(e).then((()=>{s.success("测试结果已复制到剪贴板")})).catch((e=>{s.error("复制失败")}))},we=()=>{if("Threshold"===te.type)ee.value.push({operator:">",value:"0"});else if("Conditional"===te.type)ee.value.push({operator:"point.value > 0",value:""});else if("TimeBased"===te.type)if(0===ee.value.length){const e=new Date,l=new Date(e);l.setHours(0,0,0);const a=new Date(e);a.setHours(23,59,59),W.value=l,X.value=a,ee.value.push({operator:"time",value:"timespan"})}else s.warning("时间触发类型只能设置一个时间范围条件")};return u((()=>{ie(),(async()=>{try{const e=await I();A.value=e}catch(e){s.error("获取设备列表失败")}})()})),(e,l)=>{const a=p("el-icon"),t=p("el-button"),o=p("el-input"),u=p("el-form-item"),s=p("el-option"),w=p("el-select"),I=p("el-form"),Z=p("el-card"),K=p("el-table-column"),ue=p("el-tag"),ne=p("el-button-group"),ce=p("el-table"),Ue=p("el-pagination"),ke=p("el-divider"),Ie=p("el-col"),Ce=p("el-input-number"),De=p("el-row"),Se=p("el-time-picker"),$e=p("el-switch"),xe=p("el-dialog"),Oe=p("el-date-picker"),Me=p("el-alert"),He=p("el-tab-pane"),Ne=p("el-descriptions-item"),Ee=p("el-descriptions"),Pe=p("el-tabs"),qe=y("loading");return U(),i("div",D,[n("div",S,[l[26]||(l[26]=n("h2",null,"规则引擎",-1)),d(t,{type:"primary",onClick:se},{default:r((()=>[d(a,null,{default:r((()=>[d(m(f))])),_:1}),l[25]||(l[25]=c("新增规则 "))])),_:1,__:[25]})]),d(Z,{class:"filter-container"},{default:r((()=>[d(I,{inline:!0,model:le,class:"rule-filter"},{default:r((()=>[d(u,{label:"规则名称"},{default:r((()=>[d(o,{modelValue:le.name,"onUpdate:modelValue":l[0]||(l[0]=e=>le.name=e),placeholder:"请输入规则名称",clearable:"",onClear:ie,style:{width:"220px"}},null,8,["modelValue"])])),_:1}),d(u,{label:"触发类型"},{default:r((()=>[d(w,{modelValue:le.triggerType,"onUpdate:modelValue":l[1]||(l[1]=e=>le.triggerType=e),placeholder:"请选择触发类型",clearable:"",onClear:ie,style:{width:"220px"}},{default:r((()=>[d(s,{label:"阈值触发",value:"Threshold"}),d(s,{label:"时间触发",value:"TimeBased"}),d(s,{label:"条件触发",value:"Conditional"})])),_:1},8,["modelValue"])])),_:1}),d(u,{label:"动作类型"},{default:r((()=>[d(w,{modelValue:le.actionType,"onUpdate:modelValue":l[2]||(l[2]=e=>le.actionType=e),placeholder:"请选择动作类型",clearable:"",onClear:ie,style:{width:"220px"}},{default:r((()=>[d(s,{label:"MQTT推送",value:"MQTT"}),d(s,{label:"HTTP请求",value:"HTTP"}),d(s,{label:"数据库存储",value:"Database"}),d(s,{label:"邮件通知",value:"Email"}),d(s,{label:"短信通知",value:"SMS"})])),_:1},8,["modelValue"])])),_:1}),d(u,{label:"状态"},{default:r((()=>[d(w,{modelValue:le.status,"onUpdate:modelValue":l[3]||(l[3]=e=>le.status=e),placeholder:"请选择状态",clearable:"",onClear:ie,style:{width:"220px"}},{default:r((()=>[d(s,{label:"启用",value:!0}),d(s,{label:"禁用",value:!1})])),_:1},8,["modelValue"])])),_:1}),d(u,null,{default:r((()=>[d(t,{type:"primary",onClick:ie},{default:r((()=>l[27]||(l[27]=[c("查询")]))),_:1,__:[27]}),d(t,{onClick:de},{default:r((()=>l[28]||(l[28]=[c("重置")]))),_:1,__:[28]})])),_:1})])),_:1},8,["model"])])),_:1}),d(Z,{class:"rule-list"},{default:r((()=>[v((U(),g(ce,{data:q.value,border:""},{default:r((()=>[d(K,{prop:"name",label:"规则名称","min-width":"120"}),d(K,{prop:"description",label:"描述","min-width":"200","show-overflow-tooltip":""}),d(K,{prop:"condition",label:"触发条件","min-width":"200","show-overflow-tooltip":""},{default:r((({row:e})=>{return[e.conditions&&e.conditions.length>0?(U(),i("span",$,h((l=e.conditions,l.map((e=>e.operator&&e.operator.includes("time")?e.operator:e.operator&&e.value?`${e.operator} ${e.value}`.trim():e.operator||e.value||"-")).join(" 或 "))),1)):e.condition?(U(),i("span",x,h(e.condition),1)):(U(),i("span",O,"-"))];var l})),_:1}),d(K,{prop:"action",label:"执行动作","min-width":"200","show-overflow-tooltip":""}),d(K,{prop:"priority",label:"优先级",width:"100"},{default:r((({row:e})=>{return[d(ue,{type:(l=e.priority,l<=20?"danger":l<=40?"warning":l<=60?"":l<=80?"success":"info")},{default:r((()=>[c(h(e.priority),1)])),_:2},1032,["type"])];var l})),_:1}),d(K,{prop:"status",label:"状态",width:"100"},{default:r((({row:e})=>[d(ue,{type:1===e.status?"success":"info"},{default:r((()=>[c(h(1===e.status?"启用":"禁用"),1)])),_:2},1032,["type"])])),_:1}),d(K,{prop:"createTime",label:"创建时间",width:"180"}),d(K,{label:"操作",width:"250",fixed:"right"},{default:r((({row:e})=>[d(ne,null,{default:r((()=>[d(t,{type:"primary",link:"",onClick:l=>ye(e)},{default:r((()=>l[29]||(l[29]=[c(" 编辑 ")]))),_:2,__:[29]},1032,["onClick"]),d(t,{type:"success",link:"",onClick:l=>(e=>{L.value=e,ae.deviceId=e.deviceId||0,ae.pointId=e.pointId||0,ae.triggerValue="0",ae.quality="GOOD",ae.timestamp=(new Date).toISOString(),ae.additionalData={},J.value=null,z.value=!0})(e)},{default:r((()=>l[30]||(l[30]=[c(" 测试 ")]))),_:2,__:[30]},1032,["onClick"]),d(t,{type:"primary",link:"",onClick:l=>ge(e)},{default:r((()=>[c(h(1===e.status?"禁用":"启用"),1)])),_:2},1032,["onClick"]),d(t,{type:"danger",link:"",onClick:l=>he(e)},{default:r((()=>l[31]||(l[31]=[c(" 删除 ")]))),_:2,__:[31]},1032,["onClick"])])),_:2},1024)])),_:1})])),_:1},8,["data"])),[[qe,C.value]]),n("div",M,[d(Ue,{"current-page":le.page,"onUpdate:currentPage":l[4]||(l[4]=e=>le.page=e),"page-size":le.pageSize,"onUpdate:pageSize":l[5]||(l[5]=e=>le.pageSize=e),total:j.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",onSizeChange:re,onCurrentChange:pe},null,8,["current-page","page-size","total"])])])),_:1}),d(xe,{modelValue:B.value,"onUpdate:modelValue":l[16]||(l[16]=e=>B.value=e),title:"add"===Q.value?"新增规则":"编辑规则",width:"800px"},{footer:r((()=>[d(t,{onClick:l[15]||(l[15]=e=>B.value=!1)},{default:r((()=>l[38]||(l[38]=[c("取消")]))),_:1,__:[38]}),d(t,{type:"primary",onClick:be},{default:r((()=>l[39]||(l[39]=[c("确定")]))),_:1,__:[39]})])),default:r((()=>[d(I,{ref_key:"formRef",ref:R,model:te,rules:oe,"label-width":"100px"},{default:r((()=>[d(u,{label:"规则名称",prop:"name"},{default:r((()=>[d(o,{modelValue:te.name,"onUpdate:modelValue":l[6]||(l[6]=e=>te.name=e),placeholder:"请输入规则名称"},null,8,["modelValue"])])),_:1}),d(u,{label:"描述",prop:"description"},{default:r((()=>[d(o,{modelValue:te.description,"onUpdate:modelValue":l[7]||(l[7]=e=>te.description=e),type:"textarea",placeholder:"请输入规则描述"},null,8,["modelValue"])])),_:1}),d(u,{label:"规则类型",prop:"type"},{default:r((()=>[d(w,{modelValue:te.type,"onUpdate:modelValue":l[8]||(l[8]=e=>te.type=e),placeholder:"请选择规则类型",onChange:me},{default:r((()=>[d(s,{label:"阈值触发",value:"Threshold"}),d(s,{label:"时间触发",value:"TimeBased"}),d(s,{label:"条件触发",value:"Conditional"})])),_:1},8,["modelValue"])])),_:1}),d(u,{label:"设备",prop:"deviceId"},{default:r((()=>[d(w,{modelValue:te.deviceId,"onUpdate:modelValue":l[9]||(l[9]=e=>te.deviceId=e),placeholder:"请选择设备",filterable:"",onChange:fe},{default:r((()=>[(U(!0),i(_,null,V(A.value,(e=>(U(),g(s,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),"TimeBased"!==te.type?(U(),g(u,{key:0,label:"数据点",prop:"pointId"},{default:r((()=>[d(w,{modelValue:te.pointId,"onUpdate:modelValue":l[10]||(l[10]=e=>te.pointId=e),placeholder:"请选择数据点",filterable:""},{default:r((()=>[(U(!0),i(_,null,V(Y.value,(e=>(U(),g(s,{key:e.id,label:e.name,value:e.id},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):b("",!0),d(ke,{"content-position":"center"},{default:r((()=>l[32]||(l[32]=[c("触发条件")]))),_:1,__:[32]}),d(u,null,{default:r((()=>[d(t,{type:"primary",onClick:we},{default:r((()=>[d(a,null,{default:r((()=>[d(m(f))])),_:1}),l[33]||(l[33]=c("添加条件 "))])),_:1,__:[33]})])),_:1}),(U(!0),i(_,null,V(ee.value,((e,p)=>(U(),i("div",{key:p,class:"condition-item"},[d(Z,null,{header:r((()=>[n("div",H,[n("span",null,"条件 "+h(p+1),1),d(t,{type:"danger",link:"",onClick:e=>(e=>{ee.value.splice(e,1)})(p)},{default:r((()=>[d(a,null,{default:r((()=>[d(m(k))])),_:1}),l[34]||(l[34]=c("删除 "))])),_:2,__:[34]},1032,["onClick"])])])),default:r((()=>["Threshold"===te.type?(U(),i(_,{key:0},[d(De,{gutter:20},{default:r((()=>[d(Ie,{span:12},{default:r((()=>[d(u,{label:"操作符"},{default:r((()=>[d(w,{modelValue:e.operator,"onUpdate:modelValue":l=>e.operator=l,style:{width:"100%"}},{default:r((()=>[d(s,{label:"大于",value:">"}),d(s,{label:"大于等于",value:">="}),d(s,{label:"小于",value:"<"}),d(s,{label:"小于等于",value:"<="}),d(s,{label:"等于",value:"=="}),d(s,{label:"不等于",value:"!="})])),_:2},1032,["modelValue","onUpdate:modelValue"])])),_:2},1024)])),_:2},1024),d(Ie,{span:12},{default:r((()=>[d(u,{label:"阈值"},{default:r((()=>[d(Ce,{modelValue:e.value,"onUpdate:modelValue":l=>e.value=l,placeholder:"阈值",style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024)])),_:2},1024)])),_:2},1024),d(u,{label:"预览"},{default:r((()=>[d(ue,null,{default:r((()=>[c("point.value "+h(e.operator)+" "+h(e.value),1)])),_:2},1024)])),_:2},1024)],64)):"Conditional"===te.type?(U(),i(_,{key:1},[d(u,{label:"条件表达式"},{default:r((()=>[d(o,{modelValue:e.operator,"onUpdate:modelValue":l=>e.operator=l,type:"textarea",rows:2,placeholder:"请输入条件表达式，例如：point.value > 100"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024),e.operator&&!e.operator.includes("point.value")?(U(),g(u,{key:0,label:"比较值"},{default:r((()=>[d(o,{modelValue:e.value,"onUpdate:modelValue":l=>e.value=l,placeholder:"比较值"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024)):b("",!0)],64)):"TimeBased"===te.type?(U(),i(_,{key:2},[d(u,{label:"开始时间"},{default:r((()=>[d(Se,{modelValue:W.value,"onUpdate:modelValue":l[11]||(l[11]=e=>W.value=e),format:"HH:mm:ss",placeholder:"开始时间"},null,8,["modelValue"])])),_:1}),d(u,{label:"结束时间"},{default:r((()=>[d(Se,{modelValue:X.value,"onUpdate:modelValue":l[12]||(l[12]=e=>X.value=e),format:"HH:mm:ss",placeholder:"结束时间"},null,8,["modelValue"])])),_:1})],64)):b("",!0)])),_:2},1024)])))),128)),d(ke,{"content-position":"center"},{default:r((()=>l[35]||(l[35]=[c("执行动作")]))),_:1,__:[35]}),d(u,null,{default:r((()=>[d(t,{type:"primary",onClick:ve},{default:r((()=>[d(a,null,{default:r((()=>[d(m(f))])),_:1}),l[36]||(l[36]=c("添加动作 "))])),_:1,__:[36]})])),_:1}),(U(!0),i(_,null,V(F.value,((e,p)=>(U(),i("div",{key:p,class:"action-item"},[d(Z,null,{header:r((()=>[n("div",N,[n("span",null,"动作 "+h(p+1),1),d(t,{type:"danger",link:"",onClick:e=>(e=>{F.value.splice(e,1)})(p)},{default:r((()=>[d(a,null,{default:r((()=>[d(m(k))])),_:1}),l[37]||(l[37]=c("删除 "))])),_:2,__:[37]},1032,["onClick"])])])),default:r((()=>[d(u,{label:"动作类型",prop:`actions[${p}].type`},{default:r((()=>[d(w,{modelValue:e.type,"onUpdate:modelValue":l=>e.type=l,placeholder:"请选择动作类型",onChange:()=>(e=>{const l=F.value[e];"MQTT"===l.type?l.config={topic:"",payload:""}:"HTTP"===l.type?l.config={url:"",method:"GET",body:""}:"Database"===l.type?l.config={table:"",data:""}:"Email"===l.type?l.config={to:"",subject:"",body:""}:"SMS"===l.type&&(l.config={phone:"",content:""})})(p)},{default:r((()=>[d(s,{label:"MQTT推送",value:"MQTT"}),d(s,{label:"HTTP请求",value:"HTTP"}),d(s,{label:"数据库存储",value:"Database"}),d(s,{label:"邮件通知",value:"Email"}),d(s,{label:"短信通知",value:"SMS"})])),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])])),_:2},1032,["prop"]),"MQTT"===e.type?(U(),i(_,{key:0},[d(u,{label:"主题"},{default:r((()=>[d(o,{modelValue:e.config.topic,"onUpdate:modelValue":l=>e.config.topic=l,placeholder:"请输入MQTT主题"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024),d(u,{label:"内容"},{default:r((()=>[d(o,{modelValue:e.config.payload,"onUpdate:modelValue":l=>e.config.payload=l,type:"textarea",placeholder:"请输入推送内容"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024)],64)):"HTTP"===e.type?(U(),i(_,{key:1},[d(u,{label:"URL"},{default:r((()=>[d(o,{modelValue:e.config.url,"onUpdate:modelValue":l=>e.config.url=l,placeholder:"请输入HTTP URL"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024),d(u,{label:"请求方法"},{default:r((()=>[d(w,{modelValue:e.config.method,"onUpdate:modelValue":l=>e.config.method=l},{default:r((()=>[d(s,{label:"GET",value:"GET"}),d(s,{label:"POST",value:"POST"}),d(s,{label:"PUT",value:"PUT"}),d(s,{label:"DELETE",value:"DELETE"})])),_:2},1032,["modelValue","onUpdate:modelValue"])])),_:2},1024),d(u,{label:"请求体"},{default:r((()=>[d(o,{modelValue:e.config.body,"onUpdate:modelValue":l=>e.config.body=l,type:"textarea",placeholder:"请输入请求体"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024)],64)):"Database"===e.type?(U(),i(_,{key:2},[d(u,{label:"表名"},{default:r((()=>[d(o,{modelValue:e.config.table,"onUpdate:modelValue":l=>e.config.table=l,placeholder:"请输入表名"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024),d(u,{label:"存储内容"},{default:r((()=>[d(o,{modelValue:e.config.data,"onUpdate:modelValue":l=>e.config.data=l,type:"textarea",placeholder:"请输入存储内容"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024)],64)):"Email"===e.type?(U(),i(_,{key:3},[d(u,{label:"收件人"},{default:r((()=>[d(o,{modelValue:e.config.to,"onUpdate:modelValue":l=>e.config.to=l,placeholder:"请输入收件人邮箱"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024),d(u,{label:"主题"},{default:r((()=>[d(o,{modelValue:e.config.subject,"onUpdate:modelValue":l=>e.config.subject=l,placeholder:"请输入邮件主题"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024),d(u,{label:"内容"},{default:r((()=>[d(o,{modelValue:e.config.body,"onUpdate:modelValue":l=>e.config.body=l,type:"textarea",placeholder:"请输入邮件内容"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024)],64)):"SMS"===e.type?(U(),i(_,{key:4},[d(u,{label:"手机号"},{default:r((()=>[d(o,{modelValue:e.config.phone,"onUpdate:modelValue":l=>e.config.phone=l,placeholder:"请输入手机号"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024),d(u,{label:"内容"},{default:r((()=>[d(o,{modelValue:e.config.content,"onUpdate:modelValue":l=>e.config.content=l,type:"textarea",placeholder:"请输入短信内容"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024)],64)):b("",!0)])),_:2},1024)])))),128)),d(u,{label:"优先级",prop:"priority"},{default:r((()=>[d(Ce,{modelValue:te.priority,"onUpdate:modelValue":l[13]||(l[13]=e=>te.priority=e),min:1,max:100,step:1},null,8,["modelValue"])])),_:1}),d(u,{label:"状态",prop:"enable"},{default:r((()=>[d($e,{modelValue:te.enable,"onUpdate:modelValue":l[14]||(l[14]=e=>te.enable=e),"active-value":!0,"inactive-value":!1},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue","title"]),d(xe,{modelValue:z.value,"onUpdate:modelValue":l[24]||(l[24]=e=>z.value=e),title:"规则测试",width:"600px"},{footer:r((()=>[d(t,{onClick:l[23]||(l[23]=e=>z.value=!1)},{default:r((()=>l[42]||(l[42]=[c("关闭")]))),_:1,__:[42]}),d(t,{type:"primary",onClick:_e},{default:r((()=>l[43]||(l[43]=[c("执行测试")]))),_:1,__:[43]})])),default:r((()=>[d(I,{ref_key:"testFormRef",ref:G,model:ae,"label-width":"100px"},{default:r((()=>[L.value&&"Threshold"===L.value.type?(U(),i(_,{key:0},[d(u,{label:"触发值",prop:"triggerValue"},{default:r((()=>[d(o,{modelValue:ae.triggerValue,"onUpdate:modelValue":l[17]||(l[17]=e=>ae.triggerValue=e),placeholder:"请输入触发值"},null,8,["modelValue"])])),_:1}),d(u,{label:"数据质量",prop:"quality"},{default:r((()=>[d(w,{modelValue:ae.quality,"onUpdate:modelValue":l[18]||(l[18]=e=>ae.quality=e),placeholder:"请选择数据质量"},{default:r((()=>[d(s,{label:"良好",value:"GOOD"}),d(s,{label:"不良",value:"BAD"}),d(s,{label:"不确定",value:"UNCERTAIN"})])),_:1},8,["modelValue"])])),_:1})],64)):L.value&&"TimeBased"===L.value.type?(U(),g(u,{key:1,label:"测试时间",prop:"timestamp"},{default:r((()=>[d(Oe,{modelValue:ae.timestamp,"onUpdate:modelValue":l[19]||(l[19]=e=>ae.timestamp=e),type:"datetime",placeholder:"请选择测试时间",format:"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])])),_:1})):L.value&&"Conditional"===L.value.type?(U(),i(_,{key:2},[d(u,{label:"触发值",prop:"triggerValue"},{default:r((()=>[d(o,{modelValue:ae.triggerValue,"onUpdate:modelValue":l[20]||(l[20]=e=>ae.triggerValue=e),placeholder:"请输入触发值"},null,8,["modelValue"])])),_:1}),d(u,{label:"数据质量",prop:"quality"},{default:r((()=>[d(w,{modelValue:ae.quality,"onUpdate:modelValue":l[21]||(l[21]=e=>ae.quality=e),placeholder:"请选择数据质量"},{default:r((()=>[d(s,{label:"良好",value:"GOOD"}),d(s,{label:"不良",value:"BAD"}),d(s,{label:"不确定",value:"UNCERTAIN"})])),_:1},8,["modelValue"])])),_:1}),d(u,{label:"附加数据",prop:"additionalData"},{default:r((()=>[d(o,{modelValue:ae.additionalData,"onUpdate:modelValue":l[22]||(l[22]=e=>ae.additionalData=e),type:"textarea",rows:3,placeholder:"请输入JSON格式的附加数据，用于条件表达式中使用"},null,8,["modelValue"])])),_:1})],64)):b("",!0),J.value?(U(),g(u,{key:3,label:"测试结果"},{default:r((()=>[d(Me,{title:J.value.success?"测试成功":"测试失败",type:J.value.success?"success":"error",description:J.value.errorMessage||"规则触发正常","show-icon":"",closable:!1},null,8,["title","type","description"]),J.value.success&&J.value.outputData?(U(),i("div",E,[l[41]||(l[41]=n("h4",null,"执行结果:",-1)),d(Pe,null,{default:r((()=>[d(He,{label:"输出数据"},{default:r((()=>[n("pre",null,h(JSON.stringify(J.value.outputData,null,2)),1)])),_:1}),d(He,{label:"执行详情"},{default:r((()=>[d(Ee,{border:"",column:1},{default:r((()=>[d(Ne,{label:"规则ID"},{default:r((()=>[c(h(J.value.ruleId),1)])),_:1}),d(Ne,{label:"规则名称"},{default:r((()=>[c(h(J.value.ruleName),1)])),_:1}),d(Ne,{label:"执行时间"},{default:r((()=>[c(h(J.value.executionTimeMs)+"ms",1)])),_:1}),d(Ne,{label:"测试时间"},{default:r((()=>[c(h(Ve(J.value.testTime)),1)])),_:1})])),_:1})])),_:1}),d(He,{label:"输入数据"},{default:r((()=>[n("pre",null,h(JSON.stringify(J.value.inputData,null,2)),1)])),_:1})])),_:1}),n("div",P,[d(t,{size:"small",type:"primary",onClick:Te},{default:r((()=>[d(a,null,{default:r((()=>[d(m(T))])),_:1}),l[40]||(l[40]=c("复制结果 "))])),_:1,__:[40]})])])):b("",!0)])),_:1})):b("",!0)])),_:1},8,["model"])])),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-0dc311f5"]]);export{q as default};
