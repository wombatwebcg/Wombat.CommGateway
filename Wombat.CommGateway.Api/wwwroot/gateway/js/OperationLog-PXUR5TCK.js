import{d as e,r as a,v as l,o as t,a4 as s,c as u,b as o,e as r,n as i,w as d,g as n,k as c,a5 as v,E as p,$ as f,l as m,t as _,a9 as g,aa as b,ab as y,a8 as h,ac as w,F as k,z as I,I as C,h as S,j as D}from"./index-Bm5b3KXf.js";import{L as O,a as V,s as x}from"./LogTable-CI5zpb5t.js";import{a as L,L as N,f as z,b as T,h as U,i as j}from"./log-Bjsru_W3.js";import{_ as $}from"./_plugin-vue_export-helper-BCo6x5W8.js";const E={class:"operation-log-container"},A={class:"page-header"},R={class:"header-left"},P={class:"page-title"},J={class:"header-right"},q={class:"stat-content"},B={class:"stat-icon"},F={class:"stat-info"},Q={class:"stat-value"},W={class:"stat-content"},M={class:"stat-icon success"},G={class:"stat-info"},H={class:"stat-value"},K={class:"stat-content"},X={class:"stat-icon error"},Y={class:"stat-info"},Z={class:"stat-value"},ee={class:"stat-content"},ae={class:"stat-icon warning"},le={class:"stat-info"},te={class:"stat-value"},se={class:"stat-content"},ue={class:"stat-icon primary"},oe={class:"stat-info"},re={class:"stat-value"},ie={class:"stat-content"},de={class:"stat-icon info"},ne={class:"stat-info"},ce={class:"stat-value"},ve={class:"quick-filters"},pe={class:"filter-group"},fe={class:"filter-group"},me={key:0,class:"user-operations-content"},_e={class:"user-info"},ge=$(e({__name:"OperationLog",setup(e){const $=S(),ge=a(!1),be=a([]),ye=a(0),he=a({totalCount:0,levelDistribution:{},categoryDistribution:{},recentCount:0}),we=a({page:1,pageSize:20,category:L.Operation}),ke=a("all"),Ie=a(""),Ce=a([]),Se=a(),De=a(!1),Oe=a(!1),Ve=a(),xe=a(!1),Le=a(!1),Ne=a(!1),ze=a({format:"xlsx",fields:["timestamp","userId","userName","action","resource","result","duration"]}),Te=[{label:"登录",value:"Login"},{label:"创建",value:"Create"},{label:"更新",value:"Update"},{label:"删除",value:"Delete"},{label:"查询",value:"Query"},{label:"导出",value:"Export"}],Ue=l((()=>be.value.filter((e=>"成功"===e.result)).length)),je=l((()=>be.value.filter((e=>"失败"===e.result)).length)),$e=l((()=>new Set(be.value.map((e=>e.userId)).filter(Boolean)).size)),Ee=l((()=>{const e=be.value.map((e=>e.duration)).filter(Boolean);return 0===e.length?0:Math.round(e.reduce(((e,a)=>e+a),0)/e.length)})),Ae=[{key:"userId",label:"用户ID",type:"input"},{key:"userName",label:"用户名",type:"input"},{key:"action",label:"操作动作",type:"select",options:Te},{key:"resource",label:"操作资源",type:"input"},{key:"result",label:"操作结果",type:"select",options:[{label:"成功",value:"成功"},{label:"失败",value:"失败"}]}],Re=[{prop:"userId",label:"用户ID",width:100,sortable:!0},{prop:"userName",label:"用户名",width:120,sortable:!0,formatter:e=>e||"未知用户"},{prop:"action",label:"操作",width:100,sortable:!0},{prop:"resource",label:"资源",width:120,sortable:!0},{prop:"result",label:"结果",width:80,component:"el-tag",componentProps:e=>({type:"成功"===e.result?"success":"danger",size:"small"})},{prop:"duration",label:"耗时",width:80,sortable:!0,formatter:e=>e?`${e}ms`:"-"},{prop:"ipAddress",label:"IP地址",width:130,formatter:e=>e||"未知"}];let Pe=null,Je=null,qe=null;const Be=e=>{ke.value=e;const a=(new Date).toISOString().split("T")[0];switch(e){case"success":we.value={...we.value,result:"成功",page:1};break;case"failed":we.value={...we.value,result:"失败",page:1};break;case"today":we.value={...we.value,startTime:`${a} 00:00:00`,endTime:`${a} 23:59:59`,page:1};break;default:we.value={...we.value,result:void 0,startTime:void 0,endTime:void 0,page:1}}Ye()},Fe=e=>{const a={...we.value,...e,page:1};JSON.stringify(a)!==JSON.stringify(we.value)&&(we.value=a,Ye())},Qe=(e,a)=>{we.value.page=e,we.value.pageSize=a,Ye()},We=(e,a)=>{},Me=e=>{Ce.value=e},Ge=e=>{Se.value=e,De.value=!0},He=e=>{xe.value=!0,we.value={...we.value,...e}},Ke=e=>{Ne.value=e,e?aa():la()},Xe=()=>{$.push("/log")},Ye=async()=>{ge.value=!0;try{const e=await z(we.value);be.value=e.items,ye.value=e.total}catch(e){p.error("加载数据失败"),be.value=[{id:"1",timestamp:(new Date).toISOString(),level:T.Information,category:L.Operation,message:"用户登录成功",userId:"user001",userName:"张三",action:"Login",resource:"UserAccount",result:"成功",duration:250,ipAddress:"192.168.1.100"},{id:"2",timestamp:new Date(Date.now()-3e5).toISOString(),level:T.Warning,category:L.Operation,message:"删除设备失败",userId:"user002",userName:"李四",action:"Delete",resource:"Device",resourceId:"123",result:"失败",duration:500,ipAddress:"192.168.1.101"}],ye.value=2}finally{ge.value=!1}},Ze=async()=>{try{const e=await U();he.value=e}catch(e){he.value={totalCount:890,levelDistribution:{[T.Debug]:50,[T.Information]:650,[T.Warning]:150,[T.Error]:35,[T.Critical]:5,[T.Fatal]:0},categoryDistribution:{[L.Operation]:890},recentCount:23}}},ea=async()=>{Le.value=!0;try{const e={...we.value,format:ze.value.format,fields:ze.value.fields},a=await j(e),l=URL.createObjectURL(a),t=document.createElement("a");t.href=l,t.download=`operation_logs_${(new Date).toISOString().split("T")[0]}.${ze.value.format}`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(l),p.success("导出成功"),xe.value=!1}catch(e){p.error("导出失败，请稍后重试")}finally{Le.value=!1}},aa=async()=>{try{Je=e=>{be.value.unshift(e),be.value.length>1e3&&(be.value=be.value.slice(0,1e3)),qe&&clearTimeout(qe),qe=setTimeout((()=>{Ze()}),2e3)},await x.subscribeOperationLogs(Je),p.success("已启用实时日志推送")}catch(e){p.error("启用实时推送失败"),Je=null,Pe=setInterval((()=>{Ye()}),5e3)}},la=async()=>{try{Je&&(await x.unsubscribeOperationLogs(Je),Je=null,p.info("已停用实时日志推送"))}catch(e){}Pe&&(clearInterval(Pe),Pe=null)};return t((()=>{Ye(),Ze()})),s((()=>{la(),qe&&(clearTimeout(qe),qe=null)})),(e,a)=>{const l=n("el-icon"),t=n("el-button"),s=n("el-card"),S=n("el-col"),x=n("el-row"),z=n("el-button-group"),T=n("el-descriptions-item"),U=n("el-descriptions"),j=n("el-table-column"),$=n("el-tag"),Ce=n("el-table"),Ne=n("el-dialog"),Pe=n("el-radio"),Je=n("el-radio-group"),qe=n("el-form-item"),Ze=n("el-checkbox"),aa=n("el-checkbox-group"),la=n("el-form");return D(),u("div",E,[o("div",A,[o("div",R,[o("h1",P,[r(l,{class:"title-icon"},{default:d((()=>[r(c(f))])),_:1}),a[10]||(a[10]=i(" 操作日志 "))]),a[11]||(a[11]=o("p",{class:"page-subtitle"},"用户操作记录、权限审计、业务操作追踪",-1))]),o("div",J,[r(t,{type:"primary",icon:c(v),onClick:Xe},{default:d((()=>a[12]||(a[12]=[i(" 返回日志管理 ")]))),_:1,__:[12]},8,["icon"])])]),r(x,{gutter:16,class:"stats-row"},{default:d((()=>[r(S,{span:4},{default:d((()=>[r(s,{shadow:"never",class:"stat-card"},{default:d((()=>[o("div",q,[o("div",B,[r(l,null,{default:d((()=>[r(c(m))])),_:1})]),o("div",F,[o("div",Q,_(he.value.totalCount||0),1),a[13]||(a[13]=o("div",{class:"stat-label"},"总操作数",-1))])])])),_:1})])),_:1}),r(S,{span:4},{default:d((()=>[r(s,{shadow:"never",class:"stat-card"},{default:d((()=>[o("div",W,[o("div",M,[r(l,null,{default:d((()=>[r(c(g))])),_:1})]),o("div",G,[o("div",H,_(Ue.value),1),a[14]||(a[14]=o("div",{class:"stat-label"},"成功操作",-1))])])])),_:1})])),_:1}),r(S,{span:4},{default:d((()=>[r(s,{shadow:"never",class:"stat-card"},{default:d((()=>[o("div",K,[o("div",X,[r(l,null,{default:d((()=>[r(c(b))])),_:1})]),o("div",Y,[o("div",Z,_(je.value),1),a[15]||(a[15]=o("div",{class:"stat-label"},"失败操作",-1))])])])),_:1})])),_:1}),r(S,{span:4},{default:d((()=>[r(s,{shadow:"never",class:"stat-card"},{default:d((()=>[o("div",ee,[o("div",ae,[r(l,null,{default:d((()=>[r(c(y))])),_:1})]),o("div",le,[o("div",te,_($e.value),1),a[16]||(a[16]=o("div",{class:"stat-label"},"活跃用户",-1))])])])),_:1})])),_:1}),r(S,{span:4},{default:d((()=>[r(s,{shadow:"never",class:"stat-card"},{default:d((()=>[o("div",se,[o("div",ue,[r(l,null,{default:d((()=>[r(c(h))])),_:1})]),o("div",oe,[o("div",re,_(he.value.recentCount||0),1),a[17]||(a[17]=o("div",{class:"stat-label"},"今日操作",-1))])])])),_:1})])),_:1}),r(S,{span:4},{default:d((()=>[r(s,{shadow:"never",class:"stat-card"},{default:d((()=>[o("div",ie,[o("div",de,[r(l,null,{default:d((()=>[r(c(w))])),_:1})]),o("div",ne,[o("div",ce,_(Ee.value)+"ms",1),a[18]||(a[18]=o("div",{class:"stat-label"},"平均耗时",-1))])])])),_:1})])),_:1})])),_:1}),r(s,{shadow:"never",class:"quick-filter-card"},{default:d((()=>[o("div",ve,[o("div",pe,[a[23]||(a[23]=o("span",{class:"filter-label"},"快捷筛选:",-1)),r(z,null,{default:d((()=>[r(t,{type:"all"===ke.value?"primary":"",onClick:a[0]||(a[0]=e=>Be("all"))},{default:d((()=>a[19]||(a[19]=[i(" 全部 ")]))),_:1,__:[19]},8,["type"]),r(t,{type:"success"===ke.value?"primary":"",onClick:a[1]||(a[1]=e=>Be("success"))},{default:d((()=>a[20]||(a[20]=[i(" 成功操作 ")]))),_:1,__:[20]},8,["type"]),r(t,{type:"failed"===ke.value?"primary":"",onClick:a[2]||(a[2]=e=>Be("failed"))},{default:d((()=>a[21]||(a[21]=[i(" 失败操作 ")]))),_:1,__:[21]},8,["type"]),r(t,{type:"today"===ke.value?"primary":"",onClick:a[3]||(a[3]=e=>Be("today"))},{default:d((()=>a[22]||(a[22]=[i(" 今日操作 ")]))),_:1,__:[22]},8,["type"])])),_:1})]),o("div",fe,[a[24]||(a[24]=o("span",{class:"filter-label"},"操作类型:",-1)),r(z,null,{default:d((()=>[(D(),u(k,null,I(Te,(e=>r(t,{key:e.value,type:Ie.value===e.value?"primary":"",onClick:a=>(e=>{Ie.value=Ie.value===e?"":e,we.value={...we.value,action:Ie.value||void 0,page:1},Ye()})(e.value),size:"small"},{default:d((()=>[i(_(e.label),1)])),_:2},1032,["type","onClick"]))),64))])),_:1})])])])),_:1}),r(O,{"extended-filters":Ae,"default-params":{category:c(L).Operation},onSearch:Fe,onExport:He,onRealTimeToggle:Ke},null,8,["default-params"]),r(V,{data:be.value,total:ye.value,loading:ge.value,"current-page":we.value.page,"page-size":we.value.pageSize,"dynamic-columns":Re,selectable:!0,onPageChange:Qe,onSortChange:We,onSelectionChange:Me,onViewDetail:Ge},{actions:d((({row:e})=>[r(t,{type:"primary",link:"",size:"small",onClick:a=>(async e=>{e.userId?(Ve.value={userId:e.userId,userName:e.userName||"未知用户",operations:[e,{...e,id:"mock-1",timestamp:new Date(Date.now()-36e5).toISOString(),action:"Query",result:"成功",duration:150}]},Oe.value=!0):p.warning("该操作记录没有用户信息")})(e)},{default:d((()=>a[25]||(a[25]=[i(" 用户操作 ")]))),_:2,__:[25]},1032,["onClick"])])),_:1},8,["data","total","loading","current-page","page-size"]),r(N,{modelValue:De.value,"onUpdate:modelValue":a[4]||(a[4]=e=>De.value=e),"log-data":Se.value},null,8,["modelValue","log-data"]),r(Ne,{modelValue:Oe.value,"onUpdate:modelValue":a[5]||(a[5]=e=>Oe.value=e),title:"用户操作历史",width:"70%","destroy-on-close":""},{default:d((()=>[Ve.value?(D(),u("div",me,[o("div",_e,[r(U,{column:3,border:""},{default:d((()=>[r(T,{label:"用户ID"},{default:d((()=>[i(_(Ve.value.userId),1)])),_:1}),r(T,{label:"用户名"},{default:d((()=>[i(_(Ve.value.userName),1)])),_:1}),r(T,{label:"操作次数"},{default:d((()=>[i(_(Ve.value.operations.length),1)])),_:1})])),_:1})]),r(Ce,{data:Ve.value.operations,style:{width:"100%"},"max-height":"400"},{default:d((()=>[r(j,{prop:"timestamp",label:"时间",width:"180"},{default:d((({row:e})=>{return[i(_((a=e.timestamp,new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}))),1)];var a})),_:1}),r(j,{prop:"action",label:"操作",width:"120"}),r(j,{prop:"resource",label:"资源",width:"120"}),r(j,{prop:"result",label:"结果",width:"80"},{default:d((({row:e})=>[r($,{type:"成功"===e.result?"success":"danger",size:"small"},{default:d((()=>[i(_(e.result),1)])),_:2},1032,["type"])])),_:1}),r(j,{prop:"duration",label:"耗时",width:"80"},{default:d((({row:e})=>[i(_(e.duration?`${e.duration}ms`:"-"),1)])),_:1}),r(j,{prop:"message",label:"描述","show-overflow-tooltip":""})])),_:1},8,["data"])])):C("",!0)])),_:1},8,["modelValue"]),r(Ne,{modelValue:xe.value,"onUpdate:modelValue":a[9]||(a[9]=e=>xe.value=e),title:"导出操作日志",width:"500px","destroy-on-close":""},{footer:d((()=>[r(t,{onClick:a[8]||(a[8]=e=>xe.value=!1)},{default:d((()=>a[37]||(a[37]=[i("取消")]))),_:1,__:[37]}),r(t,{type:"primary",onClick:ea,loading:Le.value},{default:d((()=>a[38]||(a[38]=[i(" 导出 ")]))),_:1,__:[38]},8,["loading"])])),default:d((()=>[r(la,{model:ze.value,"label-width":"100px"},{default:d((()=>[r(qe,{label:"导出格式"},{default:d((()=>[r(Je,{modelValue:ze.value.format,"onUpdate:modelValue":a[6]||(a[6]=e=>ze.value.format=e)},{default:d((()=>[r(Pe,{value:"xlsx"},{default:d((()=>a[26]||(a[26]=[i("Excel文件")]))),_:1,__:[26]}),r(Pe,{value:"csv"},{default:d((()=>a[27]||(a[27]=[i("CSV文件")]))),_:1,__:[27]}),r(Pe,{value:"json"},{default:d((()=>a[28]||(a[28]=[i("JSON文件")]))),_:1,__:[28]})])),_:1},8,["modelValue"])])),_:1}),r(qe,{label:"包含字段"},{default:d((()=>[r(aa,{modelValue:ze.value.fields,"onUpdate:modelValue":a[7]||(a[7]=e=>ze.value.fields=e)},{default:d((()=>[r(Ze,{value:"timestamp"},{default:d((()=>a[29]||(a[29]=[i("时间戳")]))),_:1,__:[29]}),r(Ze,{value:"userId"},{default:d((()=>a[30]||(a[30]=[i("用户ID")]))),_:1,__:[30]}),r(Ze,{value:"userName"},{default:d((()=>a[31]||(a[31]=[i("用户名")]))),_:1,__:[31]}),r(Ze,{value:"action"},{default:d((()=>a[32]||(a[32]=[i("操作动作")]))),_:1,__:[32]}),r(Ze,{value:"resource"},{default:d((()=>a[33]||(a[33]=[i("操作资源")]))),_:1,__:[33]}),r(Ze,{value:"result"},{default:d((()=>a[34]||(a[34]=[i("操作结果")]))),_:1,__:[34]}),r(Ze,{value:"duration"},{default:d((()=>a[35]||(a[35]=[i("操作耗时")]))),_:1,__:[35]}),r(Ze,{value:"ipAddress"},{default:d((()=>a[36]||(a[36]=[i("IP地址")]))),_:1,__:[36]})])),_:1},8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-21fbd3a7"]]);export{ge as default};
