var e=Object.defineProperty,a=(a,t,l)=>((a,t,l)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[t]=l)(a,"symbol"!=typeof t?t+"":t,l);import{r as t,E as l,af as o,ag as n,d as i,a as s,v as r,p as c,q as u,w as d,g as m,b as g,c as p,I as h,e as v,z as f,F as y,k as b,A as w,f as _,n as L,B as C,Q as k,ah as S,ai as H,j as x,t as V,a8 as I,N as z,aj as U,C as O,ak as T}from"./index-CNx6aW7Y.js";import{b as R,a as E}from"./log-DkeaWJ2m.js";import{_ as D}from"./_plugin-vue_export-helper-BCo6x5W8.js";const P=t("disconnected");const F=new class{constructor(){a(this,"connection",null),a(this,"systemLogHandlers",[]),a(this,"operationLogHandlers",[]),a(this,"communicationLogHandlers",[]),a(this,"isInitializing",!1)}async init(){if(!this.connection&&!this.isInitializing){this.isInitializing=!0;try{this.connection=(()=>{const e=(new o).withUrl("/hubs/log",{}).withAutomaticReconnect([0,2e3,1e4,3e4]).configureLogging(n.Information).build();return e.onclose((e=>{P.value="disconnected",e?l.error("日志服务连接已断开"):l.info("日志服务连接已关闭")})),e.onreconnecting((e=>{P.value="connecting",l.warning("正在重新连接日志服务...")})),e.onreconnected((e=>{P.value="connected",l.success("日志服务已重新连接")})),e})(),this.connection.on("ReceiveSystemLog",(e=>{this.systemLogHandlers.forEach((a=>{try{a(e)}catch(t){}}))})),this.connection.on("ReceiveOperationLog",(e=>{this.operationLogHandlers.forEach((a=>{try{a(e)}catch(t){}}))})),this.connection.on("ReceiveCommunicationLog",(e=>{this.communicationLogHandlers.forEach((a=>{try{a(e)}catch(t){}}))})),await this.connection.start(),P.value="connected"}catch(e){throw P.value="disconnected",l.error("日志服务连接失败"),e}finally{this.isInitializing=!1}}}async ensureConnection(){var e;if(this.connection||await this.init(),"Connected"!==(null==(e=this.connection)?void 0:e.state))throw new Error("SignalR连接未建立")}async subscribeSystemLogs(e){await this.ensureConnection(),this.systemLogHandlers.push(e);try{await this.connection.invoke("SubscribeSystemLogs")}catch(a){throw this.systemLogHandlers=this.systemLogHandlers.filter((a=>a!==e)),a}}async subscribeOperationLogs(e){await this.ensureConnection(),this.operationLogHandlers.push(e);try{await this.connection.invoke("SubscribeOperationLogs")}catch(a){throw this.operationLogHandlers=this.operationLogHandlers.filter((a=>a!==e)),a}}async subscribeCommunicationLogs(e){await this.ensureConnection(),this.communicationLogHandlers.push(e);try{await this.connection.invoke("SubscribeCommunicationLogs")}catch(a){throw this.communicationLogHandlers=this.communicationLogHandlers.filter((a=>a!==e)),a}}async unsubscribeSystemLogs(e){var a;if(this.systemLogHandlers=this.systemLogHandlers.filter((a=>a!==e)),0===this.systemLogHandlers.length)try{await(null==(a=this.connection)?void 0:a.invoke("UnsubscribeSystemLogs"))}catch(t){}}async unsubscribeOperationLogs(e){var a;if(this.operationLogHandlers=this.operationLogHandlers.filter((a=>a!==e)),0===this.operationLogHandlers.length)try{await(null==(a=this.connection)?void 0:a.invoke("UnsubscribeOperationLogs"))}catch(t){}}async unsubscribeCommunicationLogs(e){var a;if(this.communicationLogHandlers=this.communicationLogHandlers.filter((a=>a!==e)),0===this.communicationLogHandlers.length)try{await(null==(a=this.connection)?void 0:a.invoke("UnsubscribeCommunicationLogs"))}catch(t){}}async getSubscriptionStats(){await this.ensureConnection();try{return await this.connection.invoke("GetSubscriptionStats")}catch(e){throw e}}getConnectionState(){var e,a;return{state:P.value,isConnected:"Connected"===(null==(e=this.connection)?void 0:e.state),connectionId:null==(a=this.connection)?void 0:a.connectionId,handlerCounts:{systemLogs:this.systemLogHandlers.length,operationLogs:this.operationLogHandlers.length,communicationLogs:this.communicationLogHandlers.length}}}async close(){if(this.connection)try{await this.connection.stop()}catch(e){}finally{this.connection=null,P.value="disconnected",this.systemLogHandlers=[],this.operationLogHandlers=[],this.communicationLogHandlers=[]}}};"undefined"!=typeof window&&window.addEventListener("beforeunload",(()=>{F.close()}));const N={class:"filter-container"},j={class:"filter-item"},B={class:"filter-item"},Y={class:"filter-item"},W={class:"filter-item"},A={key:0,class:"extended-filters"},M={class:"filter-label"},$={class:"filter-actions"},G=D(i({__name:"LogFilter",props:{extendedFilters:{default:()=>[]},defaultParams:{default:()=>({})}},emits:["search","export","realTimeToggle"],setup(e,{expose:a,emit:l}){const o=e,n=l,i=t(null),I=t(),z=t(),U=t(""),O=s({}),T=t(!1),D=r((()=>({[R.Debug]:"Debug",[R.Information]:"Information",[R.Warning]:"Warning",[R.Error]:"Error",[R.Critical]:"Critical",[R.Fatal]:"Fatal"}))),P=r((()=>({[E.System]:"系统",[E.Security]:"安全",[E.Performance]:"性能",[E.Business]:"业务",[E.DataCollection]:"数据采集",[E.Communication]:"通信",[E.Operation]:"操作"}))),F=()=>{const e={page:1,pageSize:20,...o.defaultParams};return i.value&&(e.startTime=i.value[0],e.endTime=i.value[1]),void 0!==I.value&&(e.level=I.value),void 0!==z.value&&(e.category=z.value),U.value&&(e.keyword=U.value),Object.keys(O).forEach((a=>{void 0!==O[a]&&""!==O[a]&&(e[a]=O[a])})),e},G=()=>{ee()},J=()=>{ee()},K=()=>{ee()},q=()=>{clearTimeout(Q),Q=setTimeout((()=>{ee()}),500)};let Q,X=null;const Z=()=>{ee()},ee=()=>{X&&clearTimeout(X),X=setTimeout((()=>{const e=F();n("search",e)}),100)},ae=()=>{i.value=null,I.value=void 0,z.value=void 0,U.value="",Object.keys(O).forEach((e=>{O[e]=void 0})),ee()},te=()=>{const e=F();n("export",e)},le=()=>{T.value=!0,n("realTimeToggle",!0)},oe=()=>{T.value=!1,n("realTimeToggle",!1)};return c((()=>o.defaultParams),((e,a)=>{e&&a&&JSON.stringify(e)!==JSON.stringify(a)&&ee()}),{deep:!0}),a({search:ee,reset:ae,getParams:F}),(e,a)=>{const t=m("el-date-picker"),l=m("el-option"),o=m("el-select"),n=m("el-button"),s=m("el-input"),r=m("el-card");return x(),u(r,{shadow:"never",class:"filter-card"},{default:d((()=>[g("div",N,[g("div",j,[a[4]||(a[4]=g("label",{class:"filter-label"},"时间范围",-1)),v(t,{modelValue:i.value,"onUpdate:modelValue":a[0]||(a[0]=e=>i.value=e),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",onChange:G,clearable:""},null,8,["modelValue"])]),g("div",B,[a[5]||(a[5]=g("label",{class:"filter-label"},"日志级别",-1)),v(o,{modelValue:I.value,"onUpdate:modelValue":a[1]||(a[1]=e=>I.value=e),placeholder:"选择日志级别",clearable:"",onChange:J},{default:d((()=>[(x(!0),p(y,null,f(D.value,((e,a)=>(x(),u(l,{key:a,label:e,value:Number(a)},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])]),g("div",Y,[a[6]||(a[6]=g("label",{class:"filter-label"},"日志类别",-1)),v(o,{modelValue:z.value,"onUpdate:modelValue":a[2]||(a[2]=e=>z.value=e),placeholder:"选择日志类别",clearable:"",onChange:K},{default:d((()=>[(x(!0),p(y,null,f(P.value,((e,a)=>(x(),u(l,{key:a,label:e,value:Number(a)},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])]),g("div",W,[a[7]||(a[7]=g("label",{class:"filter-label"},"关键字",-1)),v(s,{modelValue:U.value,"onUpdate:modelValue":a[3]||(a[3]=e=>U.value=e),placeholder:"输入关键字搜索",clearable:"",onInput:q,onKeyup:_(ee,["enter"])},{append:d((()=>[v(n,{icon:b(w),onClick:ee},null,8,["icon"])])),_:1},8,["modelValue"])]),e.extendedFilters.length>0?(x(),p("div",A,[(x(!0),p(y,null,f(e.extendedFilters,(e=>(x(),p("div",{key:e.key,class:"filter-item"},[g("label",M,V(e.label),1),"select"===e.type?(x(),u(o,{key:0,modelValue:O[e.key],"onUpdate:modelValue":a=>O[e.key]=a,placeholder:`选择${e.label}`,clearable:"",onChange:Z},{default:d((()=>[(x(!0),p(y,null,f(e.options,(e=>(x(),u(l,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue","placeholder"])):(x(),u(s,{key:1,modelValue:O[e.key],"onUpdate:modelValue":a=>O[e.key]=a,placeholder:`输入${e.label}`,clearable:"",onInput:Z},null,8,["modelValue","onUpdate:modelValue","placeholder"]))])))),128))])):h("",!0),g("div",$,[v(n,{type:"primary",icon:b(w),onClick:ee},{default:d((()=>a[8]||(a[8]=[L(" 搜索 ")]))),_:1,__:[8]},8,["icon"]),v(n,{icon:b(C),onClick:ae},{default:d((()=>a[9]||(a[9]=[L(" 重置 ")]))),_:1,__:[9]},8,["icon"]),v(n,{icon:b(k),onClick:te},{default:d((()=>a[10]||(a[10]=[L(" 导出 ")]))),_:1,__:[10]},8,["icon"]),T.value?(x(),u(n,{key:1,type:"danger",icon:b(H),onClick:oe},{default:d((()=>a[12]||(a[12]=[L(" 停止刷新 ")]))),_:1,__:[12]},8,["icon"])):(x(),u(n,{key:0,type:"success",icon:b(S),onClick:le},{default:d((()=>a[11]||(a[11]=[L(" 实时刷新 ")]))),_:1,__:[11]},8,["icon"]))])])])),_:1})}}}),[["__scopeId","data-v-8cf2dda3"]]),J={key:0,class:"statistics-bar"},K={class:"stat-item"},q={class:"stat-value"},Q={class:"stat-item"},X={class:"stat-value"},Z={key:0,class:"stat-item"},ee={class:"stat-value text-primary"},ae={class:"timestamp-cell"},te={class:"message-cell"},le={class:"pagination-container"},oe=D(i({__name:"LogTable",props:{data:{default:()=>[]},total:{default:0},loading:{type:Boolean,default:!1},selectable:{type:Boolean,default:!1},showIndex:{type:Boolean,default:!0},showStatistics:{type:Boolean,default:!0},tableHeight:{default:"auto"},dynamicColumns:{default:()=>[]},currentPage:{default:1},pageSize:{default:20}},emits:["page-change","sort-change","selection-change","row-click","view-detail"],setup(e,{expose:a,emit:o}){const n=e,i=o,s=t(),r=t([]),w=t(n.currentPage),_=t(n.pageSize),C=t(!1),k=t(""),S=e=>({[R.Debug]:"DEBUG",[R.Information]:"INFO",[R.Warning]:"WARN",[R.Error]:"ERROR",[R.Critical]:"CRITICAL",[R.Fatal]:"FATAL"}[e]||"UNKNOWN"),H=e=>({[E.System]:"系统",[E.Security]:"安全",[E.Performance]:"性能",[E.Business]:"业务",[E.DataCollection]:"数据采集",[E.Communication]:"通信",[E.Operation]:"操作"}[e]||"未知"),D=e=>(w.value-1)*_.value+e+1,P=e=>{r.value=e,i("selection-change",e)},F=e=>{i("row-click",e)},N=({prop:e,order:a})=>{i("sort-change",e,a)},j=e=>{_.value=e,i("page-change",w.value,e)},B=e=>{w.value=e,i("page-change",e,_.value)},Y=async()=>{try{await navigator.clipboard.writeText(k.value),l.success("异常信息已复制到剪贴板")}catch(e){l.error("复制失败")}};return c((()=>n.currentPage),(e=>{w.value=e})),c((()=>n.pageSize),(e=>{_.value=e})),a({clearSelection:()=>{var e;return null==(e=s.value)?void 0:e.clearSelection()},toggleRowSelection:(e,a)=>{var t;return null==(t=s.value)?void 0:t.toggleRowSelection(e,a)},getSelectedRows:()=>r.value}),(e,a)=>{const t=m("el-table-column"),l=m("el-icon"),o=m("el-tag"),n=m("el-button"),c=m("el-table"),W=m("el-pagination"),A=m("el-input"),M=m("el-dialog"),$=m("el-card");return x(),u($,{shadow:"never",class:"table-card"},{default:d((()=>[e.showStatistics?(x(),p("div",J,[g("div",K,[a[5]||(a[5]=g("span",{class:"stat-label"},"总数:",-1)),g("span",q,V(e.total),1)]),g("div",Q,[a[6]||(a[6]=g("span",{class:"stat-label"},"当前页:",-1)),g("span",X,V(e.data.length),1)]),r.value.length>0?(x(),p("div",Z,[a[7]||(a[7]=g("span",{class:"stat-label"},"已选中:",-1)),g("span",ee,V(r.value.length),1)])):h("",!0)])):h("",!0),v(c,{ref_key:"tableRef",ref:s,data:e.data,loading:e.loading,height:e.tableHeight,"row-key":"id",onSelectionChange:P,onRowClick:F,onSortChange:N,stripe:"",border:""},{default:d((()=>[e.selectable?(x(),u(t,{key:0,type:"selection",width:"55",fixed:"left"})):h("",!0),e.showIndex?(x(),u(t,{key:1,type:"index",label:"序号",width:"80",fixed:"left",index:D})):h("",!0),v(t,{prop:"timestamp",label:"时间",width:"180",sortable:"custom",fixed:"left"},{default:d((({row:e})=>{return[g("div",ae,[v(l,{class:"time-icon"},{default:d((()=>[v(b(I))])),_:1}),g("span",null,V((a=e.timestamp,new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}))),1)])];var a})),_:1}),v(t,{prop:"level",label:"级别",width:"100",sortable:"custom"},{default:d((({row:e})=>{return[v(o,{type:(a=e.level,{[R.Debug]:"",[R.Information]:"success",[R.Warning]:"warning",[R.Error]:"danger",[R.Critical]:"danger",[R.Fatal]:"danger"}[a]||""),size:"small"},{default:d((()=>[L(V(S(e.level)),1)])),_:2},1032,["type"])];var a})),_:1}),v(t,{prop:"category",label:"类别",width:"120",sortable:"custom"},{default:d((({row:e})=>{return[v(o,{type:(a=e.category,{[E.System]:"info",[E.Security]:"warning",[E.Performance]:"success",[E.Business]:"primary",[E.DataCollection]:"",[E.Communication]:"success",[E.Operation]:"warning"}[a]||""),size:"small",effect:"plain"},{default:d((()=>[L(V(H(e.category)),1)])),_:2},1032,["type"])];var a})),_:1}),v(t,{prop:"message",label:"消息","min-width":"200","show-overflow-tooltip":""},{default:d((({row:e})=>[g("div",te,[g("span",null,V(e.message),1),e.exception?(x(),u(n,{key:0,type:"danger",link:"",size:"small",onClick:z((a=>(e=>{k.value=e.exception||"",C.value=!0})(e)),["stop"])},{default:d((()=>a[8]||(a[8]=[L(" 异常详情 ")]))),_:2,__:[8]},1032,["onClick"])):h("",!0)])])),_:1}),(x(!0),p(y,null,f(e.dynamicColumns,(e=>(x(),u(t,{key:e.prop,prop:e.prop,label:e.label,width:e.width,"min-width":e.minWidth,sortable:!!e.sortable&&"custom","show-overflow-tooltip":!1!==e.showOverflowTooltip},{default:d((({row:a})=>{var t;return[(x(),u(O(e.component||"span"),T({ref_for:!0},(null==(t=e.componentProps)?void 0:t.call(e,a))||{}),{default:d((()=>[L(V(e.formatter?e.formatter(a[e.prop],a):a[e.prop]),1)])),_:2},1040))]})),_:2},1032,["prop","label","width","min-width","sortable","show-overflow-tooltip"])))),128)),v(t,{label:"操作",width:"120",fixed:"right"},{default:d((({row:t})=>[v(n,{type:"primary",link:"",size:"small",onClick:e=>(e=>{i("view-detail",e)})(t)},{default:d((()=>a[9]||(a[9]=[L(" 详情 ")]))),_:2,__:[9]},1032,["onClick"]),U(e.$slots,"actions",{row:t},void 0,!0)])),_:3})])),_:3},8,["data","loading","height"]),g("div",le,[v(W,{"current-page":w.value,"onUpdate:currentPage":a[0]||(a[0]=e=>w.value=e),"page-size":_.value,"onUpdate:pageSize":a[1]||(a[1]=e=>_.value=e),total:e.total,"page-sizes":[10,20,50,100,200],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:j,onCurrentChange:B},null,8,["current-page","page-size","total"])]),v(M,{modelValue:C.value,"onUpdate:modelValue":a[4]||(a[4]=e=>C.value=e),title:"异常详情",width:"60%","destroy-on-close":""},{footer:d((()=>[v(n,{onClick:a[3]||(a[3]=e=>C.value=!1)},{default:d((()=>a[10]||(a[10]=[L("关闭")]))),_:1,__:[10]}),v(n,{type:"primary",onClick:Y},{default:d((()=>a[11]||(a[11]=[L("复制")]))),_:1,__:[11]})])),default:d((()=>[v(A,{modelValue:k.value,"onUpdate:modelValue":a[2]||(a[2]=e=>k.value=e),type:"textarea",rows:15,readonly:"",class:"exception-textarea"},null,8,["modelValue"])])),_:1},8,["modelValue"])])),_:3})}}}),[["__scopeId","data-v-901cac25"]]);export{G as L,oe as a,F as s};
