<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketæ•°æ®é‡‡é›†æœåŠ¡æµ‹è¯•ï¼ˆç²¾ç¡®æ¨é€ç‰ˆï¼‰</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .unsubscribe {
            background-color: #dc3545;
        }
        
        .unsubscribe:hover:not(:disabled) {
            background-color: #c82333;
        }
        
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .message {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007bff;
            background-color: white;
        }
        
        .message.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        
        .message.success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        
        .message.data-update {
            border-left-color: #17a2b8;
            background-color: #d1ecf1;
        }
        
        .message.precise-push {
            border-left-color: #6f42c1;
            background-color: #e2e3f0;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .subscription-list {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .data-counter {
            background-color: #17a2b8;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px;
            display: inline-block;
        }
        
        .fix-status {
            background-color: #6f42c1;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .push-validation {
            background-color: #e7f3ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <h1>WebSocketæ•°æ®é‡‡é›†æœåŠ¡æµ‹è¯•ï¼ˆç²¾ç¡®æ¨é€ç‰ˆï¼‰</h1>
    
    <div class="container">
        <div class="fix-status">
            ğŸ¯ ç²¾ç¡®æ¨é€æ¨¡å‹ï¼šç°åœ¨ç³»ç»Ÿé‡‡ç”¨åŸºäºè®¢é˜…å…³ç³»çš„ç²¾ç¡®æ¨é€ï¼Œæ¯ä¸ªè¿æ¥åªæ”¶åˆ°å®ƒè®¢é˜…çš„ç‚¹ä½æ›´æ–°
        </div>
        <div class="push-validation">
            <strong>ğŸ“Š æ¨é€éªŒè¯åŠŸèƒ½ï¼š</strong>
            <span id="pushValidation">ç­‰å¾…è¿æ¥å»ºç«‹...</span>
        </div>
        <h2>è¿æ¥çŠ¶æ€</h2>
        <div id="status" class="status disconnected">æœªè¿æ¥</div>
        <button onclick="connect()">è¿æ¥</button>
        <button onclick="disconnect()">æ–­å¼€è¿æ¥</button>
        <button onclick="ping()">å‘é€å¿ƒè·³</button>
        <button onclick="getStats()">è·å–ç»Ÿè®¡</button>
        <button onclick="clearMessages()">æ¸…é™¤æ¶ˆæ¯</button>
        <button onclick="validatePrecisePush()" style="background-color: #6f42c1;">ğŸ¯ éªŒè¯ç²¾ç¡®æ¨é€</button>
    </div>

    <div class="grid">
        <div class="container">
            <h2>è®¢é˜…ç®¡ç†</h2>
            
            <h3>è®¾å¤‡è®¢é˜…</h3>
            <input type="number" id="deviceId" placeholder="è®¾å¤‡ID" value="1">
            <button onclick="subscribeDevice()">è®¢é˜…è®¾å¤‡</button>
            <button onclick="unsubscribeDevice()" class="unsubscribe">å–æ¶ˆè®¢é˜…è®¾å¤‡</button>
            
            <h3>ç»„è®¢é˜…</h3>
            <input type="number" id="groupId" placeholder="ç»„ID" value="1">
            <button onclick="subscribeGroup()">è®¢é˜…ç»„</button>
            <button onclick="unsubscribeGroup()" class="unsubscribe">å–æ¶ˆè®¢é˜…ç»„</button>
            
            <h3>ç‚¹ä½è®¢é˜…</h3>
            <input type="number" id="pointId" placeholder="ç‚¹ä½ID" value="1">
            <button onclick="subscribePoint()">è®¢é˜…ç‚¹ä½</button>
            <button onclick="unsubscribePoint()" class="unsubscribe">å–æ¶ˆè®¢é˜…ç‚¹ä½</button>
            
            <button onclick="getSubscriptionStatus()">è·å–è®¢é˜…çŠ¶æ€</button>
            
            <div id="subscriptions" class="subscription-list">
                <strong>å½“å‰è®¢é˜…ï¼š</strong><span id="subscriptionList">æ— </span>
            </div>
            
            <div>
                <span class="data-counter">æ€»æ•°æ®æ›´æ–°: <span id="dataCounter">0</span></span>
                <span class="data-counter">ç²¾ç¡®æ¨é€: <span id="precisePushCounter">0</span></span>
                <span class="data-counter">æ‰¹é‡æ¨é€: <span id="batchPushCounter">0</span></span>
                <span class="data-counter">æ— æ•ˆæ¨é€: <span id="invalidPushCounter">0</span></span>
            </div>
            
            <h3>ğŸ¯ ç²¾ç¡®æ¨é€æµ‹è¯•</h3>
            <input type="number" id="testPointId1" placeholder="æµ‹è¯•ç‚¹ä½1" value="1">
            <input type="number" id="testPointId2" placeholder="æµ‹è¯•ç‚¹ä½2" value="2">
            <button onclick="testPrecisePushScenario()" style="background-color: #6f42c1;">æµ‹è¯•ç²¾ç¡®æ¨é€åœºæ™¯</button>
            
            <h3>è°ƒè¯•åŠŸèƒ½</h3>
            <input type="number" id="debugPointId" placeholder="è°ƒè¯•ç‚¹ä½ID" value="1">
            <button onclick="getSchedulerStatus()">è·å–è°ƒåº¦å™¨çŠ¶æ€</button>
            <button onclick="getHierarchyStatus()">è·å–å±‚çº§å…³ç³»</button>
            <button onclick="testDataPush()">æµ‹è¯•æ•°æ®æ¨é€</button>
            <button onclick="getPointStatus()">è·å–ç‚¹ä½çŠ¶æ€</button>
            <button onclick="getPointSubscriptionDetails()">ğŸ” è¯Šæ–­è®¢é˜…è¯¦æƒ…</button>
            
            <h3>ğŸ› è®¾å¤‡å–æ¶ˆè®¢é˜…æµ‹è¯•</h3>
            <input type="number" id="testDeviceId" placeholder="æµ‹è¯•è®¾å¤‡ID" value="1">
            <button onclick="testDeviceUnsubscribe()" style="background-color: #dc3545;">ğŸ§ª æµ‹è¯•è®¾å¤‡å–æ¶ˆè®¢é˜…</button>
            <button onclick="forceRefreshStatus()">ğŸ”„ å¼ºåˆ¶åˆ·æ–°çŠ¶æ€</button>
            
            <h3>ğŸ”§ é«˜çº§è¯Šæ–­å·¥å…·</h3>
            <button onclick="getAllConnectionDetails()" style="background-color: #6f42c1;">ğŸ“‹ è·å–æ‰€æœ‰è¿æ¥è¯¦æƒ…</button>
            <br>
            <input type="text" id="cleanupConnectionId" placeholder="è¿æ¥IDï¼ˆç•™ç©º=å½“å‰è¿æ¥ï¼‰" style="width: 200px;">
            <select id="cleanupType">
                <option value="device">è®¾å¤‡è®¢é˜…</option>
                <option value="group">è®¾å¤‡ç»„è®¢é˜…</option>
                <option value="point">ç‚¹ä½è®¢é˜…</option>
                <option value="all">æ‰€æœ‰è®¢é˜…</option>
            </select>
            <input type="number" id="cleanupTargetId" placeholder="ç›®æ ‡IDï¼ˆå¯é€‰ï¼‰" style="width: 100px;">
            <button onclick="forceCleanupSubscription()" style="background-color: #dc3545;">ğŸ—‘ï¸ å¼ºåˆ¶æ¸…ç†è®¢é˜…</button>
            
            <h3>ğŸ“Š ä¸»åŠ¨æ•°æ®æ¨é€</h3>
            <input type="number" id="pushDeviceId" placeholder="è®¾å¤‡ID" value="1">
            <button onclick="getDeviceData()" style="background-color: #17a2b8;">ğŸ“± è·å–è®¾å¤‡æ•°æ®</button>
            <br>
            <input type="number" id="pushGroupId" placeholder="è®¾å¤‡ç»„ID" value="1">
            <button onclick="getGroupData()" style="background-color: #6f42c1;">ğŸ—‚ï¸ è·å–è®¾å¤‡ç»„æ•°æ®</button>
            
            <div id="subscriptionDiagnosis" style="background-color: #e7f3ff; padding: 10px; border-radius: 4px; margin: 10px 0; display: none;">
                <h4>ğŸ“Š è®¢é˜…è¯Šæ–­ç»“æœ</h4>
                <div id="diagnosisContent"></div>
            </div>
            
            <div id="schedulerStatus" style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; display: none;">
                <h4>âš™ï¸ è°ƒåº¦å™¨è¯¦ç»†çŠ¶æ€</h4>
                <div id="schedulerContent"></div>
            </div>
            
            <div id="connectionDetails" style="background-color: #fff3cd; padding: 10px; border-radius: 4px; margin: 10px 0; display: none;">
                <h4>ğŸ“‹ æ‰€æœ‰è¿æ¥è¯¦æƒ…</h4>
                <div id="connectionDetailsContent"></div>
            </div>
            
            <div id="cleanupResult" style="background-color: #d1ecf1; padding: 10px; border-radius: 4px; margin: 10px 0; display: none;">
                <h4>ğŸ—‘ï¸ æ¸…ç†ç»“æœ</h4>
                <div id="cleanupResultContent"></div>
            </div>
            
            <div id="pushTestResult" style="background-color: #e2e3f0; padding: 10px; border-radius: 4px; margin: 10px 0; display: none;">
                <h4>ğŸ¯ ç²¾ç¡®æ¨é€æµ‹è¯•ç»“æœ</h4>
                <div id="pushTestContent"></div>
            </div>
        </div>

        <div class="container">
            <h2>æ¶ˆæ¯æ—¥å¿—</h2>
            <div id="messages" class="messages"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let dataCounter = 0;
        let precisePushCounter = 0;
        let batchPushCounter = 0;
        let invalidPushCounter = 0;
        let connectionId = null;
        let currentSubscriptions = {
            devices: [],
            groups: [],
            points: []
        };
        let testScenarioRunning = false;
        let expectedPushes = [];

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function addMessage(message, type = 'info') {
            const messagesEl = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            messageEl.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function updateCounters() {
            document.getElementById('dataCounter').textContent = dataCounter;
            document.getElementById('precisePushCounter').textContent = precisePushCounter;
            document.getElementById('batchPushCounter').textContent = batchPushCounter;
            document.getElementById('invalidPushCounter').textContent = invalidPushCounter;
        }

        function updatePushValidation() {
            const validationEl = document.getElementById('pushValidation');
            if (connectionId) {
                const totalExpected = currentSubscriptions.devices.length + currentSubscriptions.groups.length + currentSubscriptions.points.length;
                validationEl.innerHTML = `
                    è¿æ¥ ${connectionId} | è®¢é˜…: ${totalExpected}ä¸ª | 
                    ç²¾ç¡®æ¨é€: ${precisePushCounter}ä¸ª | 
                    æ— æ•ˆæ¨é€: ${invalidPushCounter}ä¸ª | 
                    ç²¾ç¡®ç‡: ${totalExpected > 0 ? ((precisePushCounter / (precisePushCounter + invalidPushCounter)) * 100).toFixed(1) : '0'}%
                `;
            } else {
                validationEl.textContent = 'ç­‰å¾…è¿æ¥å»ºç«‹...';
            }
        }

        function validatePushMessage(data) {
            // éªŒè¯æ¨é€æ¶ˆæ¯æ˜¯å¦ç¬¦åˆå½“å‰è®¢é˜…
            let isValid = false;
            let reason = '';
            
            if (data.type === 'point_update' || data.type === 'pointupdate') {
                const pointId = data.data.PointId || data.data.pointId;
                if (pointId) {
                    // æ£€æŸ¥æ˜¯å¦ç›´æ¥è®¢é˜…äº†ç‚¹ä½
                    if (currentSubscriptions.points.includes(pointId)) {
                        isValid = true;
                        reason = `ç›´æ¥è®¢é˜…ç‚¹ä½${pointId}`;
                    } else {
                        // è¿™é‡Œåº”è¯¥æ£€æŸ¥ç‚¹ä½æ‰€å±çš„è®¾å¤‡å’Œè®¾å¤‡ç»„è®¢é˜…
                        // ç®€åŒ–ç‰ˆæœ¬ï¼Œå‡è®¾å¦‚æœæœ‰ä»»ä½•è®¾å¤‡æˆ–ç»„è®¢é˜…å°±å¯èƒ½æœ‰æ•ˆ
                        if (currentSubscriptions.devices.length > 0 || currentSubscriptions.groups.length > 0) {
                            isValid = true;
                            reason = `é€šè¿‡è®¾å¤‡æˆ–ç»„è®¢é˜…æ¥æ”¶ç‚¹ä½${pointId}`;
                        } else {
                            reason = `ç‚¹ä½${pointId}æœªè®¢é˜…ä¸”æ— ç›¸å…³è®¾å¤‡/ç»„è®¢é˜…`;
                        }
                    }
                }
            } else if (data.type === 'batch_points_update' || data.type === 'batchpointsupdate') {
                // æ‰¹é‡æ›´æ–°éœ€è¦æ£€æŸ¥æ›´æ–°çš„ç‚¹ä½æ˜¯å¦éƒ½åœ¨è®¢é˜…èŒƒå›´å†…
                if (currentSubscriptions.points.length > 0 || currentSubscriptions.devices.length > 0 || currentSubscriptions.groups.length > 0) {
                    isValid = true;
                    reason = 'æ‰¹é‡æ›´æ–°åŒ…å«è®¢é˜…çš„ç‚¹ä½';
                } else {
                    reason = 'æ‰¹é‡æ›´æ–°ä½†æ— ä»»ä½•è®¢é˜…';
                }
            }
            
            return { isValid, reason };
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addMessage('WebSocketå·²ç»è¿æ¥', 'error');
                return;
            }

            updateStatus('è¿æ¥ä¸­...', 'connecting');
            addMessage('æ­£åœ¨è¿æ¥åˆ° ws://localhost:5000/ws/datacollection-ws...');

            ws = new WebSocket('ws://localhost:5000/ws/datacollection-ws');

            ws.onopen = function(event) {
                updateStatus('å·²è¿æ¥', 'connected');
                addMessage('WebSocketè¿æ¥å·²å»ºç«‹', 'success');
                addMessage('ğŸ¯ ç²¾ç¡®æ¨é€æ¨¡å‹ï¼šç°åœ¨ç³»ç»Ÿé‡‡ç”¨åŸºäºè®¢é˜…å…³ç³»çš„ç²¾ç¡®æ¨é€æ¶æ„', 'success');
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                } catch (e) {
                    addMessage(`è§£ææ¶ˆæ¯å¤±è´¥: ${event.data}`, 'error');
                }
            };

            ws.onclose = function(event) {
                updateStatus('å·²æ–­å¼€è¿æ¥', 'disconnected');
                addMessage(`WebSocketè¿æ¥å…³é—­ (code: ${event.code}, reason: ${event.reason})`, 'error');
                connectionId = null;
                updatePushValidation();
            };

            ws.onerror = function(error) {
                updateStatus('è¿æ¥é”™è¯¯', 'disconnected');
                addMessage(`WebSocketé”™è¯¯: ${error}`, 'error');
            };
        }

        function handleMessage(data) {
            addMessage(`æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data, null, 2)}`);

            // å¦‚æœæ˜¯æ•°æ®æ¨é€æ¶ˆæ¯ï¼ŒéªŒè¯ç²¾ç¡®æ€§
            if (data.type && (data.type.includes('update') || data.type.includes('point'))) {
                const validation = validatePushMessage(data);
                if (validation.isValid) {
                    precisePushCounter++;
                    addMessage(`âœ… ç²¾ç¡®æ¨é€éªŒè¯é€šè¿‡: ${validation.reason}`, 'precise-push');
                } else {
                    invalidPushCounter++;
                    addMessage(`âŒ æ— æ•ˆæ¨é€æ£€æµ‹: ${validation.reason}`, 'error');
                }
                updateCounters();
                updatePushValidation();
            }

            switch (data.type) {
                case 'connection_status':
                    connectionId = data.data.connectionId;
                    addMessage(`è¿æ¥ID: ${connectionId}`, 'success');
                    updatePushValidation();
                    break;

                case 'subscription_confirmed':
                    addMessage(`è®¢é˜…ç¡®è®¤: ${data.data.target} ${data.data.id}`, 'success');
                    // æ›´æ–°æœ¬åœ°è®¢é˜…çŠ¶æ€
                    updateLocalSubscriptions(data.data.target, data.data.id, 'add');
                    break;

                case 'unsubscription_confirmed':
                    addMessage(`å–æ¶ˆè®¢é˜…ç¡®è®¤: ${data.data.target} ${data.data.id}`, 'success');
                    // æ›´æ–°æœ¬åœ°è®¢é˜…çŠ¶æ€
                    updateLocalSubscriptions(data.data.target, data.data.id, 'remove');
                    break;

                case 'subscription_status':
                    const subData = data.data;
                    addMessage(`ğŸ“Š è®¢é˜…çŠ¶æ€å·²æ›´æ–° - æ€»è®¢é˜…æ•°: ${subData.totalSubscriptions}`, 'success');
                    
                    // æ›´æ–°æœ¬åœ°è®¢é˜…çŠ¶æ€
                    currentSubscriptions = {
                        devices: subData.deviceSubscriptions || [],
                        groups: subData.groupSubscriptions || [],
                        points: subData.pointSubscriptions || []
                    };
                    
                    // è¯¦ç»†æ˜¾ç¤ºå„ç±»å‹è®¢é˜…
                    if (subData.groupSubscriptions && subData.groupSubscriptions.length > 0) {
                        addMessage(`ğŸ—‚ï¸ è®¾å¤‡ç»„è®¢é˜…: [${subData.groupSubscriptions.join(', ')}] (${subData.groupSubscriptions.length}ä¸ª)`, 'success');
                    } else {
                        addMessage(`ğŸ—‚ï¸ è®¾å¤‡ç»„è®¢é˜…: æ— `, 'success');
                    }
                    
                    if (subData.deviceSubscriptions && subData.deviceSubscriptions.length > 0) {
                        addMessage(`ğŸ–¥ï¸ è®¾å¤‡è®¢é˜…: [${subData.deviceSubscriptions.join(', ')}] (${subData.deviceSubscriptions.length}ä¸ª)`, 'success');
                    } else {
                        addMessage(`ğŸ–¥ï¸ è®¾å¤‡è®¢é˜…: æ— `, 'success');
                    }
                    
                    if (subData.pointSubscriptions && subData.pointSubscriptions.length > 0) {
                        addMessage(`ğŸ“ ç‚¹ä½è®¢é˜…: [${subData.pointSubscriptions.join(', ')}] (${subData.pointSubscriptions.length}ä¸ª)`, 'success');
                    } else {
                        addMessage(`ğŸ“ ç‚¹ä½è®¢é˜…: æ— `, 'success');
                    }
                    
                    // æ›´æ–°é¡µé¢æ˜¾ç¤º
                    const allSubscriptions = [
                        ...(subData.groupSubscriptions || []).map(id => `ç»„${id}`),
                        ...(subData.deviceSubscriptions || []).map(id => `è®¾å¤‡${id}`),
                        ...(subData.pointSubscriptions || []).map(id => `ç‚¹ä½${id}`)
                    ];
                    document.getElementById('subscriptionList').textContent = 
                        allSubscriptions.length > 0 ? allSubscriptions.join(', ') : 'æ— ';
                    
                    updatePushValidation();
                    break;

                case 'connection_statistics':
                    addMessage(`è¿æ¥ç»Ÿè®¡: æ€»è¿æ¥æ•°=${data.data.totalConnections}, æ€»è®¢é˜…æ•°=${data.data.totalSubscriptions}`, 'success');
                    break;

                case 'scheduler_status':
                    addMessage(`âš™ï¸ è°ƒåº¦å™¨çŠ¶æ€å·²æ›´æ–°ï¼Œè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ä¸‹æ–¹çŠ¶æ€é¢æ¿`, 'success');
                    
                    // æ˜¾ç¤ºåœ¨ä¸“é—¨çš„çŠ¶æ€åŒºåŸŸ
                    const schedulerDiv = document.getElementById('schedulerStatus');
                    const schedulerContentDiv = document.getElementById('schedulerContent');
                    
                    let statusHtml = `
                        <div style="margin-bottom: 15px;">
                            <strong>ğŸƒ è¿è¡ŒçŠ¶æ€:</strong> ${data.data.isRunning ? 'âœ… è¿è¡Œä¸­' : 'âŒ å·²åœæ­¢'}<br>
                            <strong>ğŸ“Š è°ƒåº¦ç‚¹ä½:</strong> ${data.data.scheduledPointCount} ä¸ª<br>
                            <strong>â±ï¸ ä»»åŠ¡é¢‘ç‡:</strong> é¢„è®¡ ${data.data.estimatedTasksPerMinute} ä¸ª/åˆ†é’Ÿ
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>ğŸ“ˆ ä»»åŠ¡ç»Ÿè®¡:</strong><br>
                            â€¢ æ€»ä»»åŠ¡æ•°: ${data.data.statistics.totalScheduledTasks} ä¸ª<br>
                            â€¢ æˆåŠŸä»»åŠ¡: ${data.data.statistics.successfulTasks} ä¸ª<br>
                            â€¢ å¤±è´¥ä»»åŠ¡: ${data.data.statistics.failedTasks} ä¸ª<br>
                            â€¢ æˆåŠŸç‡: ${(data.data.statistics.successRate * 100).toFixed(1)}%
                        </div>
                        
                        <div style="background-color: #d1ecf1; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                            <strong>â“ å…³äº"æ€»ä»»åŠ¡æ•°"çš„è¯´æ˜:</strong><br>
                            â€¢ ${data.data.explanation.totalScheduledTasks}<br>
                            â€¢ ${data.data.explanation.whyIncreasing}<br>
                            â€¢ ${data.data.explanation.currentRate}<br>
                            â€¢ ${data.data.explanation.taskGrouping}
                        </div>
                    `;
                    
                    // æ·»åŠ æ‰«æå‘¨æœŸåˆ†ç»„ä¿¡æ¯
                    if (data.data.scanRateGroups && data.data.scanRateGroups.length > 0) {
                        statusHtml += `
                            <div style="margin-bottom: 15px;">
                                <strong>ğŸ“‹ æ‰«æå‘¨æœŸåˆ†ç»„:</strong><br>
                                <table style="width: 100%; border-collapse: collapse; margin-top: 5px;">
                                    <thead>
                                        <tr style="background-color: #e9ecef;">
                                            <th style="border: 1px solid #ddd; padding: 5px;">æ‰«æå‘¨æœŸ</th>
                                            <th style="border: 1px solid #ddd; padding: 5px;">ç‚¹ä½æ•°é‡</th>
                                            <th style="border: 1px solid #ddd; padding: 5px;">ä»»åŠ¡é¢‘ç‡</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        data.data.scanRateGroups.forEach(group => {
                            statusHtml += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 5px;">${group.scanRateMs}ms</td>
                                    <td style="border: 1px solid #ddd; padding: 5px;">${group.pointCount}ä¸ª</td>
                                    <td style="border: 1px solid #ddd; padding: 5px;">${group.tasksPerMinute}æ¬¡/åˆ†é’Ÿ</td>
                                </tr>
                            `;
                        });
                        statusHtml += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                    
                    // æ·»åŠ é€šé“åˆ†ç»„ä¿¡æ¯
                    if (data.data.channelGroups && data.data.channelGroups.length > 0) {
                        statusHtml += `
                            <div style="margin-bottom: 15px;">
                                <strong>ğŸ”Œ é€šé“åˆ†ç»„:</strong><br>
                        `;
                        data.data.channelGroups.forEach(group => {
                            statusHtml += `â€¢ é€šé“${group.channelId}: ${group.pointCount}ä¸ªç‚¹ä½<br>`;
                        });
                        statusHtml += `</div>`;
                    }
                    
                    schedulerContentDiv.innerHTML = statusHtml;
                    schedulerDiv.style.display = 'block';
                    
                    // æ»šåŠ¨åˆ°çŠ¶æ€åŒºåŸŸ
                    schedulerDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    break;

                case 'hierarchy_status':
                    addMessage(`å±‚çº§å…³ç³»: ç‚¹ä½${data.data.pointId}, ç›´æ¥è®¢é˜…${data.data.directSubscribers}ä¸ª, æ€»è¿æ¥${data.data.totalConnections}ä¸ª`, 'success');
                    addMessage(`è®¾å¤‡ä¿¡æ¯: ${data.data.deviceInfo}`, 'success');
                    addMessage(`è®¾å¤‡ç»„ä¿¡æ¯: ${data.data.groupInfo}`, 'success');
                    break;

                case 'test_data_push_sent':
                    addMessage(`æµ‹è¯•æ•°æ®æ¨é€å·²å‘é€: ${data.data.message}`, 'success');
                    break;

                case 'point_status':
                    const pointData = data.data;
                    addMessage(`ç‚¹ä½${pointData.pointId}çŠ¶æ€: è°ƒåº¦å™¨æ³¨å†Œ=${pointData.isRegisteredInScheduler}`, 'success');
                    if (pointData.pointInfo) {
                        addMessage(`ç‚¹ä½ä¿¡æ¯: åç§°=${pointData.pointInfo.name}, å¯ç”¨=${pointData.pointInfo.enable}, æ‰«æå‘¨æœŸ=${pointData.pointInfo.scanRate}`, 'success');
                    }
                    if (pointData.cachedValue) {
                        addMessage(`ç¼“å­˜å€¼: ${pointData.cachedValue.value}, çŠ¶æ€=${pointData.cachedValue.status}`, 'success');
                    }
                    break;

                case 'point_subscription_details':
                    const diagData = data.data;
                    addMessage(`ğŸ” ç‚¹ä½${diagData.pointId}è®¢é˜…è¯Šæ–­å®Œæˆ`, 'success');
                    
                    // æ˜¾ç¤ºè¯Šæ–­ç»“æœ
                    const diagnosisDiv = document.getElementById('subscriptionDiagnosis');
                    const contentDiv = document.getElementById('diagnosisContent');
                    
                    let diagnosisHtml = `
                        <div style="margin-bottom: 15px;">
                            <strong>ğŸ“‹ è¯Šæ–­ç»“æœï¼š</strong><br>
                            <span style="color: ${diagData.willReceiveUpdates ? '#28a745' : '#dc3545'}; font-weight: bold;">
                                ${diagData.explanation}
                            </span>
                        </div>
                    `;
                    
                    if (diagData.willReceiveUpdates && diagData.subscriptionReasons.length > 0) {
                        diagnosisHtml += `
                            <div style="margin-bottom: 15px;">
                                <strong>ğŸ”— è®¢é˜…è·¯å¾„ï¼š</strong>
                                <ul style="margin: 5px 0; padding-left: 20px;">
                                    ${diagData.subscriptionReasons.map(reason => `<li>${reason}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    diagnosisHtml += `
                        <div style="margin-bottom: 15px;">
                            <strong>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š</strong><br>
                            â€¢ æ€»è®¢é˜…è€…: ${diagData.statistics.totalSubscriberCount} ä¸ª<br>
                            â€¢ ç›´æ¥è®¢é˜…ç‚¹ä½: ${diagData.statistics.directSubscriberCount} ä¸ª<br>
                            â€¢ è®¢é˜…è®¾å¤‡${diagData.deviceId ? ` ${diagData.deviceId}` : ''}: ${diagData.statistics.deviceSubscriberCount} ä¸ª<br>
                            â€¢ è®¢é˜…è®¾å¤‡ç»„${diagData.groupId ? ` ${diagData.groupId}` : ''}: ${diagData.statistics.groupSubscriberCount} ä¸ª
                        </div>
                    `;
                    
                    if (!diagData.willReceiveUpdates) {
                        diagnosisHtml += `
                            <div style="background-color: #d1ecf1; padding: 10px; border-radius: 4px; border-left: 4px solid #17a2b8;">
                                <strong>ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                                å¦‚æœæ‚¨æƒ³æ¥æ”¶ç‚¹ä½${diagData.pointId}çš„æ•°æ®æ¨é€ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œä¹‹ä¸€ï¼š<br>
                                â€¢ ç›´æ¥è®¢é˜…ç‚¹ä½${diagData.pointId}<br>
                                ${diagData.deviceId ? `â€¢ è®¢é˜…è®¾å¤‡${diagData.deviceId}ï¼ˆåŒ…å«è¯¥ç‚¹ä½ï¼‰<br>` : ''}
                                ${diagData.groupId ? `â€¢ è®¢é˜…è®¾å¤‡ç»„${diagData.groupId}ï¼ˆåŒ…å«è¯¥è®¾å¤‡å’Œç‚¹ä½ï¼‰<br>` : ''}
                            </div>
                        `;
                    } else {
                        diagnosisHtml += `
                            <div style="background-color: #d4edda; padding: 10px; border-radius: 4px; border-left: 4px solid #28a745;">
                                <strong>ğŸ›‘ å¦‚ä½•åœæ­¢æ¥æ”¶æ¨é€ï¼š</strong><br>
                                è¦å®Œå…¨åœæ­¢æ¥æ”¶ç‚¹ä½${diagData.pointId}çš„æ•°æ®æ¨é€ï¼Œæ‚¨éœ€è¦å–æ¶ˆä»¥ä¸‹æ‰€æœ‰è®¢é˜…ï¼š<br>
                                ${diagData.subscriptionReasons.map(reason => `â€¢ ${reason}<br>`).join('')}
                            </div>
                        `;
                    }
                    
                    contentDiv.innerHTML = diagnosisHtml;
                    diagnosisDiv.style.display = 'block';
                    
                    // æ»šåŠ¨åˆ°è¯Šæ–­ç»“æœ
                    diagnosisDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    break;

                case 'device_data':
                    const deviceData = data.data;
                    addMessage(`ğŸ“± è®¾å¤‡${deviceData.deviceId}æ•°æ®è·å–å®Œæˆ`, 'success');
                    addMessage(`è®¾å¤‡ä¿¡æ¯: åç§°=${deviceData.deviceName}, å¯ç”¨=${deviceData.deviceEnable}, é€šé“=${deviceData.channelId}`, 'success');
                    addMessage(`åŒ…å«ç‚¹ä½: ${deviceData.pointCount}ä¸ª, å¿«ç…§æ—¶é—´=${new Date(deviceData.snapshotTime).toLocaleString()}`, 'success');
                    
                    if (deviceData.points && deviceData.points.length > 0) {
                        addMessage(`ğŸ“Š ç‚¹ä½è¯¦æƒ…:`, 'success');
                        deviceData.points.forEach((point, index) => {
                            if (index < 5) { // åªæ˜¾ç¤ºå‰5ä¸ªç‚¹ä½ï¼Œé¿å…æ—¥å¿—è¿‡é•¿
                                addMessage(`  â€¢ ç‚¹ä½${point.pointId}: ${point.name} = ${point.value} (${point.status})`, 'success');
                            }
                        });
                        if (deviceData.points.length > 5) {
                            addMessage(`  ... è¿˜æœ‰${deviceData.points.length - 5}ä¸ªç‚¹ä½`, 'success');
                        }
                    }
                    break;

                case 'group_data':
                    const groupData = data.data;
                    addMessage(`ğŸ—‚ï¸ è®¾å¤‡ç»„${groupData.groupId}æ•°æ®è·å–å®Œæˆ`, 'success');
                    addMessage(`è®¾å¤‡ç»„ä¿¡æ¯: åç§°=${groupData.groupName}`, 'success');
                    addMessage(`åŒ…å«è®¾å¤‡: ${groupData.deviceCount}ä¸ª, æ€»ç‚¹ä½: ${groupData.pointCount}ä¸ª`, 'success');
                    addMessage(`å¿«ç…§æ—¶é—´: ${new Date(groupData.snapshotTime).toLocaleString()}`, 'success');
                    
                    if (groupData.devices && groupData.devices.length > 0) {
                        addMessage(`ğŸ“Š è®¾å¤‡è¯¦æƒ…:`, 'success');
                        groupData.devices.forEach((device, index) => {
                            if (index < 3) { // åªæ˜¾ç¤ºå‰3ä¸ªè®¾å¤‡
                                addMessage(`  â€¢ è®¾å¤‡${device.deviceId}: ${device.deviceName} (${device.pointCount}ä¸ªç‚¹ä½)`, 'success');
                            }
                        });
                        if (groupData.devices.length > 3) {
                            addMessage(`  ... è¿˜æœ‰${groupData.devices.length - 3}ä¸ªè®¾å¤‡`, 'success');
                        }
                    }
                    break;

                case 'all_connection_details':
                    const connectionsData = data.data;
                    addMessage(`ğŸ“‹ è·å–åˆ°æ‰€æœ‰è¿æ¥è¯¦æƒ…ï¼Œæ€»è¿æ¥æ•°: ${connectionsData.totalConnections}`, 'success');
                    
                    // æ˜¾ç¤ºåœ¨ä¸“é—¨çš„è¿æ¥è¯¦æƒ…åŒºåŸŸ
                    const connectionDetailsDiv = document.getElementById('connectionDetails');
                    const connectionDetailsContentDiv = document.getElementById('connectionDetailsContent');
                    
                    let connectionsHtml = `
                        <div style="margin-bottom: 15px;">
                            <strong>ğŸ“Š è¿æ¥æ¦‚è§ˆ:</strong> æ€»è¿æ¥æ•° ${connectionsData.totalConnections}<br>
                        </div>
                    `;
                    
                    if (connectionsData.connections && connectionsData.connections.length > 0) {
                        connectionsHtml += `
                            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                                <thead>
                                    <tr style="background-color: #e9ecef;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">è¿æ¥ID</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">æœ€åæ´»åŠ¨</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">æ€»è®¢é˜…</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">è®¾å¤‡ç»„</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">è®¾å¤‡</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">ç‚¹ä½</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        connectionsData.connections.forEach(conn => {
                            const lastActivity = conn.lastActivityTime === '0001-01-01T00:00:00' ? 'ä»æœªæ´»åŠ¨' : new Date(conn.lastActivityTime).toLocaleString();
                            connectionsHtml += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px; font-family: monospace;">${conn.connectionId}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${lastActivity}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${conn.totalSubscriptions}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">[${conn.groupSubscriptions.join(', ')}]</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">[${conn.deviceSubscriptions.join(', ')}]</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">[${conn.pointSubscriptions.join(', ')}]</td>
                                </tr>
                            `;
                        });
                        
                        connectionsHtml += `
                                </tbody>
                            </table>
                        `;
                    } else {
                        connectionsHtml += `<p>æ²¡æœ‰æ‰¾åˆ°ä»»ä½•è¿æ¥</p>`;
                    }
                    
                    connectionDetailsContentDiv.innerHTML = connectionsHtml;
                    connectionDetailsDiv.style.display = 'block';
                    connectionDetailsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    break;

                case 'force_cleanup_result':
                    const cleanupData = data.data;
                    addMessage(`ğŸ—‘ï¸ å¼ºåˆ¶æ¸…ç†è®¢é˜…å®Œæˆ: ${cleanupData.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`, cleanupData.success ? 'success' : 'error');
                    
                    // æ˜¾ç¤ºåœ¨ä¸“é—¨çš„æ¸…ç†ç»“æœåŒºåŸŸ
                    const cleanupResultDiv = document.getElementById('cleanupResult');
                    const cleanupResultContentDiv = document.getElementById('cleanupResultContent');
                    
                    let cleanupHtml = `
                        <div style="margin-bottom: 15px;">
                            <strong>ğŸ¯ æ¸…ç†ç›®æ ‡:</strong> è¿æ¥ ${cleanupData.targetConnectionId}<br>
                            <strong>ğŸ“‚ è®¢é˜…ç±»å‹:</strong> ${cleanupData.subscriptionType}<br>
                            ${cleanupData.targetId ? `<strong>ğŸ”¢ ç›®æ ‡ID:</strong> ${cleanupData.targetId}<br>` : ''}
                            <strong>âœ… æ‰§è¡Œç»“æœ:</strong> <span style="color: ${cleanupData.success ? '#28a745' : '#dc3545'}; font-weight: bold;">${cleanupData.success ? 'æˆåŠŸ' : 'å¤±è´¥'}</span><br>
                            <strong>ğŸ“Š ç§»é™¤æ•°é‡:</strong> ${cleanupData.removedCount}<br>
                            <strong>ğŸ’¬ æ¶ˆæ¯:</strong> ${cleanupData.message}
                        </div>
                    `;
                    
                    if (cleanupData.details && cleanupData.details.length > 0) {
                        cleanupHtml += `
                            <div style="background-color: #f8f9fa; padding: 10px; border-radius: 4px;">
                                <strong>ğŸ“‹ è¯¦ç»†ä¿¡æ¯:</strong>
                                <ul style="margin: 5px 0; padding-left: 20px;">
                                    ${cleanupData.details.map(detail => `<li>${detail}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    cleanupResultContentDiv.innerHTML = cleanupHtml;
                    cleanupResultDiv.style.display = 'block';
                    cleanupResultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    
                    // æ¸…ç†åè‡ªåŠ¨åˆ·æ–°è®¢é˜…çŠ¶æ€
                    setTimeout(() => getSubscriptionStatus(), 1000);
                    break;

                case 'point_update':
                case 'pointupdate':
                    dataCounter++;
                    addMessage(`ğŸ¯ ç²¾ç¡®æ¨é€ç”Ÿæ•ˆï¼ç‚¹ä½æ›´æ–°: ç‚¹ä½=${data.data.PointId || data.data.pointId}, å€¼=${data.data.Value || data.data.value}, çŠ¶æ€=${data.data.Status || data.data.status}`, 'data-update');
                    break;

                case 'batch_points_update':
                case 'batchpointsupdate':
                    dataCounter++;
                    batchPushCounter++;
                    updateCounters();
                    const updateCount = data.data.Updates ? data.data.Updates.length : (data.data.updates ? data.data.updates.length : 0);
                    addMessage(`ğŸ¯ æ‰¹é‡ç²¾ç¡®æ¨é€ç”Ÿæ•ˆï¼æ‰¹é‡ç‚¹ä½æ›´æ–°: ${updateCount}ä¸ªç‚¹ä½`, 'data-update');
                    break;

                case 'point_status_change':
                case 'pointstatuschange':
                    dataCounter++;
                    addMessage(`ğŸ¯ ç²¾ç¡®æ¨é€ç”Ÿæ•ˆï¼ç‚¹ä½çŠ¶æ€å˜æ›´: ç‚¹ä½=${data.data.PointId || data.data.pointId}, çŠ¶æ€=${data.data.Status || data.data.status}`, 'data-update');
                    break;

                case 'point_removed':
                case 'pointremoved':
                    dataCounter++;
                    addMessage(`ğŸ¯ ç²¾ç¡®æ¨é€ç”Ÿæ•ˆï¼ç‚¹ä½ç§»é™¤: ç‚¹ä½=${data.data.PointId || data.data.pointId}`, 'data-update');
                    break;

                case 'pong':
                    addMessage('æ”¶åˆ°å¿ƒè·³å“åº”', 'success');
                    break;

                case 'error':
                    addMessage(`é”™è¯¯: ${data.error}`, 'error');
                    break;

                default:
                    addMessage(`æœªçŸ¥æ¶ˆæ¯ç±»å‹: ${data.type}`);
                    break;
            }
        }

        function updateLocalSubscriptions(target, id, action) {
            const targetKey = target === 'device' ? 'devices' : (target === 'group' ? 'groups' : 'points');
            if (action === 'add') {
                if (!currentSubscriptions[targetKey].includes(id)) {
                    currentSubscriptions[targetKey].push(id);
                }
            } else if (action === 'remove') {
                const index = currentSubscriptions[targetKey].indexOf(id);
                if (index > -1) {
                    currentSubscriptions[targetKey].splice(index, 1);
                }
            }
            updatePushValidation();
        }

        function sendCommand(command) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addMessage('WebSocketæœªè¿æ¥', 'error');
                return;
            }

            const message = JSON.stringify(command);
            ws.send(message);
            addMessage(`å‘é€å‘½ä»¤: ${message}`);
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function subscribeDevice() {
            const deviceId = parseInt(document.getElementById('deviceId').value);
            if (isNaN(deviceId)) {
                addMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„è®¾å¤‡ID', 'error');
                return;
            }
            sendCommand({
                action: 'subscribe',
                target: 'device',
                id: deviceId
            });
            // è®¢é˜…åè‡ªåŠ¨è·å–çŠ¶æ€
            setTimeout(() => getSubscriptionStatus(), 500);
        }

        function unsubscribeDevice() {
            const deviceId = parseInt(document.getElementById('deviceId').value);
            if (isNaN(deviceId)) {
                addMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„è®¾å¤‡ID', 'error');
                return;
            }
            addMessage(`ğŸ”„ æ­£åœ¨å–æ¶ˆè®¢é˜…è®¾å¤‡${deviceId}...`, 'success');
            sendCommand({
                action: 'unsubscribe',
                target: 'device',
                id: deviceId
            });
            // å–æ¶ˆè®¢é˜…åè‡ªåŠ¨è·å–çŠ¶æ€éªŒè¯
            setTimeout(() => {
                getSubscriptionStatus();
                addMessage(`âœ… è®¾å¤‡${deviceId}å–æ¶ˆè®¢é˜…æ“ä½œå·²å‘é€ï¼Œè¯·æ£€æŸ¥ä¸Šæ–¹è®¢é˜…çŠ¶æ€æ˜¯å¦å·²æ›´æ–°`, 'success');
            }, 500);
        }

        function subscribeGroup() {
            const groupId = parseInt(document.getElementById('groupId').value);
            if (isNaN(groupId)) {
                addMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„ç»„ID', 'error');
                return;
            }
            sendCommand({
                action: 'subscribe',
                target: 'group',
                id: groupId
            });
            // è®¢é˜…åè‡ªåŠ¨è·å–çŠ¶æ€
            setTimeout(() => getSubscriptionStatus(), 500);
        }

        function unsubscribeGroup() {
            const groupId = parseInt(document.getElementById('groupId').value);
            if (isNaN(groupId)) {
                addMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„ç»„ID', 'error');
                return;
            }
            sendCommand({
                action: 'unsubscribe',
                target: 'group',
                id: groupId
            });
            // å–æ¶ˆè®¢é˜…åè‡ªåŠ¨è·å–çŠ¶æ€éªŒè¯
            setTimeout(() => getSubscriptionStatus(), 500);
        }

        function subscribePoint() {
            const pointId = parseInt(document.getElementById('pointId').value);
            if (isNaN(pointId)) {
                addMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„ç‚¹ä½ID', 'error');
                return;
            }
            sendCommand({
                action: 'subscribe',
                target: 'point',
                id: pointId
            });
            // è®¢é˜…åè‡ªåŠ¨è·å–çŠ¶æ€
            setTimeout(() => getSubscriptionStatus(), 500);
        }

        function unsubscribePoint() {
            const pointId = parseInt(document.getElementById('pointId').value);
            if (isNaN(pointId)) {
                addMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„ç‚¹ä½ID', 'error');
                return;
            }
            sendCommand({
                action: 'unsubscribe',
                target: 'point',
                id: pointId
            });
            // å–æ¶ˆè®¢é˜…åè‡ªåŠ¨è·å–çŠ¶æ€éªŒè¯
            setTimeout(() => getSubscriptionStatus(), 500);
        }

        function ping() {
            sendCommand({
                action: 'ping'
            });
        }

        function getSubscriptionStatus() {
            sendCommand({
                action: 'get_subscription_status'
            });
        }

        function getStats() {
            sendCommand({
                action: 'get_connection_statistics'
            });
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
            dataCounter = 0;
            precisePushCounter = 0;
            batchPushCounter = 0;
            invalidPushCounter = 0;
            updateCounters();
            updatePushValidation();
        }

        function getSchedulerStatus() {
            sendCommand({
                action: 'get_scheduler_status'
            });
        }

        function getHierarchyStatus() {
            const pointId = parseInt(document.getElementById('debugPointId').value);
            if (isNaN(pointId)) {
                addMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„è°ƒè¯•ç‚¹ä½ID', 'error');
                return;
            }
            sendCommand({
                action: 'get_hierarchy_status',
                id: pointId
            });
        }

        function testDataPush() {
            sendCommand({
                action: 'test_data_push'
            });
        }

        function getPointStatus() {
            const pointId = parseInt(document.getElementById('debugPointId').value);
            if (isNaN(pointId)) {
                addMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„è°ƒè¯•ç‚¹ä½ID', 'error');
                return;
            }
            sendCommand({
                action: 'get_point_status',
                id: pointId
            });
        }

        function getPointSubscriptionDetails() {
            const pointId = parseInt(document.getElementById('debugPointId').value);
            if (isNaN(pointId)) {
                addMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„è°ƒè¯•ç‚¹ä½ID', 'error');
                return;
            }
            sendCommand({
                action: 'get_point_subscription_details',
                id: pointId
            });
        }

        function testDeviceUnsubscribe() {
            const deviceId = parseInt(document.getElementById('testDeviceId').value);
            if (isNaN(deviceId)) {
                addMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„è®¾å¤‡ID', 'error');
                return;
            }
            addMessage(`ğŸ”„ æ­£åœ¨æµ‹è¯•è®¾å¤‡${deviceId}å–æ¶ˆè®¢é˜…...`, 'success');
            sendCommand({
                action: 'unsubscribe',
                target: 'device',
                id: deviceId
            });
            // æµ‹è¯•åè‡ªåŠ¨è·å–çŠ¶æ€éªŒè¯
            setTimeout(() => {
                getSubscriptionStatus();
                addMessage(`âœ… è®¾å¤‡${deviceId}å–æ¶ˆè®¢é˜…æµ‹è¯•å·²å‘é€ï¼Œè¯·æ£€æŸ¥ä¸Šæ–¹è®¢é˜…çŠ¶æ€æ˜¯å¦å·²æ›´æ–°`, 'success');
            }, 500);
        }

        function forceRefreshStatus() {
            getSubscriptionStatus();
            getSchedulerStatus();
            getHierarchyStatus();
            getPointStatus();
            getPointSubscriptionDetails();
            addMessage('ğŸ”„ å·²å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰çŠ¶æ€ä¿¡æ¯', 'success');
        }

        function getDeviceData() {
            const deviceId = parseInt(document.getElementById('pushDeviceId').value);
            if (isNaN(deviceId)) {
                addMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„è®¾å¤‡ID', 'error');
                return;
            }
            addMessage(`ğŸ”„ æ­£åœ¨è·å–è®¾å¤‡${deviceId}çš„æ•°æ®...`, 'success');
            sendCommand({
                action: 'get_device_data',
                id: deviceId
            });
        }

        function getGroupData() {
            const groupId = parseInt(document.getElementById('pushGroupId').value);
            if (isNaN(groupId)) {
                addMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„è®¾å¤‡ç»„ID', 'error');
                return;
            }
            addMessage(`ğŸ”„ æ­£åœ¨è·å–è®¾å¤‡ç»„${groupId}çš„æ•°æ®...`, 'success');
            sendCommand({
                action: 'get_group_data',
                id: groupId
            });
        }

        function getAllConnectionDetails() {
            addMessage(`ğŸ”„ æ­£åœ¨è·å–æ‰€æœ‰è¿æ¥è¯¦æƒ…...`, 'success');
            sendCommand({
                action: 'get_all_connection_details'
            });
        }

        function forceCleanupSubscription() {
            const targetConnectionId = document.getElementById('cleanupConnectionId').value.trim();
            const cleanupType = document.getElementById('cleanupType').value;
            const targetIdValue = document.getElementById('cleanupTargetId').value;
            const targetId = targetIdValue ? parseInt(targetIdValue) : 0;
            
            if (!cleanupType) {
                addMessage('è¯·é€‰æ‹©æ¸…ç†ç±»å‹', 'error');
                return;
            }
            
            const targetDesc = targetConnectionId || 'å½“å‰è¿æ¥';
            const typeDesc = cleanupType === 'all' ? 'æ‰€æœ‰è®¢é˜…' : `${cleanupType}è®¢é˜…${targetId > 0 ? ` ${targetId}` : ''}`;
            addMessage(`ğŸ—‘ï¸ æ­£åœ¨å¼ºåˆ¶æ¸…ç† ${targetDesc} çš„ ${typeDesc}...`, 'success');
            
            const command = {
                action: 'force_cleanup_subscription',
                subscriptionType: cleanupType
            };
            
            if (targetConnectionId) {
                command.connectionId = targetConnectionId;
            }
            
            if (targetId > 0) {
                command.id = targetId;
            }
            
            sendCommand(command);
        }

        function validatePrecisePush() {
            addMessage('ğŸ¯ å¼€å§‹éªŒè¯ç²¾ç¡®æ¨é€...', 'success');
            // å‘é€æµ‹è¯•æ•°æ®æ¨é€
            testDataPush();
            // 1ç§’åæ£€æŸ¥ç»“æœ
            setTimeout(() => {
                const precision = invalidPushCounter === 0 ? 100 : ((precisePushCounter / (precisePushCounter + invalidPushCounter)) * 100);
                addMessage(`ğŸ¯ ç²¾ç¡®æ¨é€éªŒè¯ç»“æœ: ç²¾ç¡®ç‡ ${precision.toFixed(1)}%`, precision >= 95 ? 'success' : 'error');
                if (precision < 95) {
                    addMessage('âŒ æ£€æµ‹åˆ°æ— æ•ˆæ¨é€ï¼Œè¯·æ£€æŸ¥è®¢é˜…å…³ç³»', 'error');
                } else {
                    addMessage('âœ… ç²¾ç¡®æ¨é€éªŒè¯é€šè¿‡', 'success');
                }
            }, 1000);
        }

        function testPrecisePushScenario() {
            const point1 = parseInt(document.getElementById('testPointId1').value);
            const point2 = parseInt(document.getElementById('testPointId2').value);
            
            if (isNaN(point1) || isNaN(point2)) {
                addMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„æµ‹è¯•ç‚¹ä½ID', 'error');
                return;
            }
            
            testScenarioRunning = true;
            addMessage('ğŸ¯ å¼€å§‹ç²¾ç¡®æ¨é€åœºæ™¯æµ‹è¯•...', 'success');
            
            const testDiv = document.getElementById('pushTestResult');
            const testContent = document.getElementById('pushTestContent');
            
            let testHtml = `
                <div style="margin-bottom: 15px;">
                    <strong>ğŸ§ª æµ‹è¯•åœºæ™¯:</strong> è®¢é˜…ç‚¹ä½${point1}ï¼Œä¸è®¢é˜…ç‚¹ä½${point2}<br>
                    <strong>ğŸ“Š é¢„æœŸç»“æœ:</strong> åªæ¥æ”¶ç‚¹ä½${point1}çš„æ¨é€ï¼Œä¸æ¥æ”¶ç‚¹ä½${point2}çš„æ¨é€
                </div>
                <div id="testProgress">
                    <div style="background-color: #fff3cd; padding: 10px; border-radius: 4px;">
                        â³ æµ‹è¯•è¿›è¡Œä¸­...
                    </div>
                </div>
            `;
            
            testContent.innerHTML = testHtml;
            testDiv.style.display = 'block';
            
            // æ¸…ç†ç°æœ‰è®¢é˜…
            addMessage('ğŸ§¹ æ¸…ç†ç°æœ‰è®¢é˜…...', 'success');
            
            // æ‰§è¡Œæµ‹è¯•åºåˆ—
            setTimeout(() => {
                // è®¢é˜…ç‚¹ä½1
                addMessage(`ğŸ“ è®¢é˜…ç‚¹ä½${point1}...`, 'success');
                sendCommand({
                    action: 'subscribe',
                    target: 'point',
                    id: point1
                });
                
                setTimeout(() => {
                    // å‘é€æµ‹è¯•æ•°æ®æ¨é€
                    addMessage('ğŸ”„ å‘é€æµ‹è¯•æ•°æ®æ¨é€...', 'success');
                    testDataPush();
                    
                    setTimeout(() => {
                        // åˆ†æç»“æœ
                        const testProgressDiv = document.getElementById('testProgress');
                        if (testProgressDiv) {
                            const receivedPushes = precisePushCounter;
                            const invalidPushes = invalidPushCounter;
                            const totalPushes = receivedPushes + invalidPushes;
                            
                            let resultHtml = `
                                <div style="background-color: ${invalidPushes === 0 ? '#d4edda' : '#f8d7da'}; padding: 10px; border-radius: 4px;">
                                    <strong>ğŸ¯ æµ‹è¯•ç»“æœ:</strong><br>
                                    â€¢ æ¥æ”¶åˆ°çš„æ¨é€: ${receivedPushes}ä¸ª<br>
                                    â€¢ æ— æ•ˆæ¨é€: ${invalidPushes}ä¸ª<br>
                                    â€¢ ç²¾ç¡®ç‡: ${totalPushes > 0 ? ((receivedPushes / totalPushes) * 100).toFixed(1) : 0}%<br>
                                    <strong>ç»“è®º:</strong> ${invalidPushes === 0 ? 'âœ… ç²¾ç¡®æ¨é€éªŒè¯é€šè¿‡' : 'âŒ æ£€æµ‹åˆ°æ— æ•ˆæ¨é€'}
                                </div>
                            `;
                            
                            testProgressDiv.innerHTML = resultHtml;
                        }
                        
                        testScenarioRunning = false;
                        addMessage('ğŸ¯ ç²¾ç¡®æ¨é€åœºæ™¯æµ‹è¯•å®Œæˆ', 'success');
                    }, 2000);
                }, 1000);
            }, 1000);
        }

        // é¡µé¢åŠ è½½æ—¶æ›´æ–°è®¡æ•°å™¨
        updateCounters();
        updatePushValidation();
        
        // æ·»åŠ é¡µé¢åŠ è½½å®Œæˆæç¤º
        window.addEventListener('load', function() {
            addMessage('ğŸ¯ ç²¾ç¡®æ¨é€æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
            addMessage('', 'success');
            addMessage('ğŸš€ æœ€æ–°ä¼˜åŒ–å†…å®¹ï¼š', 'success');
            addMessage('1. ğŸ¯ ç²¾ç¡®æ¨é€æ¨¡å‹ï¼šé‡‡ç”¨åŸºäºè®¢é˜…å…³ç³»çš„ç²¾ç¡®æ¨é€æ¶æ„', 'success');
            addMessage('2. ğŸ“Š æ¨é€éªŒè¯ï¼šå®æ—¶ç›‘æ§æ¨é€æ¶ˆæ¯çš„ç²¾ç¡®æ€§', 'success');
            addMessage('3. ğŸ” æ™ºèƒ½åˆ†æï¼šè‡ªåŠ¨æ£€æµ‹æ— æ•ˆæ¨é€å¹¶æä¾›åŸå› ', 'success');
            addMessage('4. ğŸ§ª åœºæ™¯æµ‹è¯•ï¼šæä¾›ç²¾ç¡®æ¨é€åœºæ™¯æµ‹è¯•åŠŸèƒ½', 'success');
            addMessage('5. ğŸ“ˆ å®æ—¶ç»Ÿè®¡ï¼šæ˜¾ç¤ºç²¾ç¡®æ¨é€ç‡å’Œæ— æ•ˆæ¨é€æ•°é‡', 'success');
            addMessage('', 'success');
            addMessage('ğŸ¯ ç²¾ç¡®æ¨é€åŸç†ï¼š', 'success');
            addMessage('â€¢ æ¯ä¸ªè¿æ¥åªæ”¶åˆ°å®ƒè®¢é˜…çš„ç‚¹ä½æ›´æ–°', 'success');
            addMessage('â€¢ æŒ‰è¿æ¥åˆ†ç»„è¿›è¡Œé«˜æ•ˆæ‰¹é‡æ¨é€', 'success');
            addMessage('â€¢ æ™ºèƒ½æ¶ˆæ¯æ ¼å¼é€‰æ‹©ï¼ˆå•ç‚¹ä½/æ‰¹é‡ï¼‰', 'success');
            addMessage('â€¢ é¿å…å…¨å±€å¹¿æ’­ï¼Œæœç»æ— æ•ˆæ¨é€', 'success');
            addMessage('', 'success');
            addMessage('ğŸ“Š æ¨é€éªŒè¯åŠŸèƒ½ï¼š', 'success');
            addMessage('â€¢ å®æ—¶ç›‘æ§æ¯ä¸ªæ¨é€æ¶ˆæ¯çš„æœ‰æ•ˆæ€§', 'success');
            addMessage('â€¢ è‡ªåŠ¨è®¡ç®—ç²¾ç¡®æ¨é€ç‡', 'success');
            addMessage('â€¢ æ£€æµ‹å¹¶ç»Ÿè®¡æ— æ•ˆæ¨é€', 'success');
            addMessage('â€¢ æä¾›è¯¦ç»†çš„æ¨é€åˆ†ææŠ¥å‘Š', 'success');
            addMessage('', 'success');
            addMessage('ğŸ§ª æµ‹è¯•å»ºè®®ï¼š', 'success');
            addMessage('â€¢ ä½¿ç”¨"ğŸ¯ éªŒè¯ç²¾ç¡®æ¨é€"æŒ‰é’®è¿›è¡Œå¿«é€ŸéªŒè¯', 'success');
            addMessage('â€¢ ä½¿ç”¨"æµ‹è¯•ç²¾ç¡®æ¨é€åœºæ™¯"è¿›è¡Œå…¨é¢æµ‹è¯•', 'success');
            addMessage('â€¢ è§‚å¯Ÿæ¨é€éªŒè¯åŒºåŸŸçš„å®æ—¶ç»Ÿè®¡', 'success');
            addMessage('â€¢ å¦‚æœå‘ç°æ— æ•ˆæ¨é€ï¼Œè¯·ä½¿ç”¨è¯Šæ–­å·¥å…·æŸ¥æ‰¾åŸå› ', 'success');
        });
    </script>
</body>
</html> 